<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mayi Prompt UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                        info: '#3B82F6',
                        light: '#F8FAFC',
                        dark: '#1E293B',
                        r18: '#db2777',
                        newTag: '#8B5CF6'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .main-title {
            font-size: 28px !important;
            font-weight: 700;
            color: #1e293b;
            text-align: center;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .subtitle {
            font-size: 16px !important;
            font-weight: 500;
            color: #64748b;
            text-align: center;
            margin-bottom: 24px;
            letter-spacing: 0.5px;
        }
        
        .section-title {
            font-size: 18px !important;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .app-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            border: 1px solid #e2e8f0;
        }
        
        .tag-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white !important;
            border: 2px solid transparent;
            border-radius: 8px !important;
            padding: 4px 8px;
            margin: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
            position: relative;
            flex-wrap: nowrap;
            min-width: fit-content;
        }
        
        .tag-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.9);
        }
        
        .tag-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }
        
        .tag-text {
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.3px;
            font-size: 12px !important;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
            margin-bottom: 0;
        }
        
        .tag-name {
            font-weight: 500;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
            font-size: 11px !important;
            white-space: nowrap !important;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }
        
        .tag-actions {
            display: flex;
            gap: 2px;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 10;
            opacity: 0.7;
        }
        
        .tag-item:hover .tag-actions {
            opacity: 1;
        }
        
        .tag-actions button {
            width: 18px !important;
            height: 18px !important;
            font-size: 10px !important;
            padding: 0 !important;
            border-radius: 4px !important;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            min-height: 18px;
            transition: all 0.2s ease;
            opacity: 0.9;
        }
        
        .tag-actions button:hover:not(:disabled) {
            transform: scale(1.2);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
            opacity: 1;
        }
        
        .tab-button {
            transition: all 0.3s ease;
            font-weight: 600;
            padding: 8px 14px !important;
            font-size: 14px !important;
            min-height: 40px;
            border-radius: 8px !important;
            margin: 0 3px !important;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
            white-space: nowrap;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%) !important;
            color: white !important;
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .tab-button:not(.active) {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%) !important;
            color: #475569 !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        
        .tab-button.r18-tab {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%) !important;
            color: #be123c !important;
        }
        
        .tab-button.r18-tab.active {
            background: linear-gradient(135deg, #db2777 0%, #be185d 100%) !important;
            color: white !important;
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .group-add-button {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%) !important;
            color: white !important;
            border: 2px solid transparent !important;
            border-radius: 8px !important;
            padding: 4px 8px !important;
            font-size: 12px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            margin: 2px !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 6px !important;
            min-height: 40px !important;
            min-width: fit-content !important;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3) !important;
        }
        
        .group-add-button:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4) !important;
            border-color: rgba(255, 255, 255, 0.9) !important;
        }
        
        .btn {
            transition: all 0.3s ease;
            font-weight: 600;
            border-radius: 8px !important;
            padding: 5px 10px !important;
            font-size: 12px !important;
            min-height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%) !important;
            color: white !important;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%) !important;
            color: white !important;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%) !important;
            color: white !important;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%) !important;
            color: white !important;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%) !important;
            color: white !important;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #94A3B8 0%, #64748B 100%) !important;
            color: white !important;
        }
        
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: flex-start;
            justify-content: flex-start;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border: 2px solid #e2e8f0;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            padding: 16px;
            border-bottom: 2px solid #e2e8f0;
            color: #1e293b;
        }
        
        .modal-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 16px;
            border-top: 2px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        

        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .notification {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 1000;
            font-weight: 600;
            padding: 10px 16px !important;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            font-size: 13px !important;
            min-height: 40px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 2px solid transparent;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            visibility: visible;
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
        }
        
        .notification.error {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            color: white;
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
        }
        
        .notification.info {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            color: white;
        }
        
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            margin-left: 4px;
        }
        
        .tag-actions .pin-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            color: white !important;
        }
        
        .tag-actions .favorite-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            color: white !important;
        }
        
        .tag-actions .edit-tag-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
            color: white !important;
        }
        
        .tag-actions .delete-tag-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            color: white !important;
        }
        
        .tag-actions .add-group-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            color: white !important;
        }
        
        .title-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .title-actions {
            display: flex;
            gap: 6px;
        }
        
        .selected-tag-item {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 4px 8px;
            margin: 2px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
            position: relative;
            flex-wrap: nowrap;
            min-width: fit-content;
        }
        
        .selected-tag-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #4F46E5;
        }
        
        .selected-tag-actions {
            display: flex;
            gap: 2px;
            flex-shrink: 0;
        }
        
        .selected-tag-btn {
            width: 16px !important;
            height: 16px !important;
            font-size: 8px !important;
            padding: 0 !important;
            border-radius: 3px !important;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 16px;
            min-height: 16px;
            opacity: 0.8;
        }
        
        .selected-tag-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        
        .preset-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .preset-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #4F46E5;
        }
        
        .preset-name {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }
        
        .preset-description {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 12px;
        }
        
        .preset-prompt {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            font-size: 12px;
            color: #1e293b;
            margin-bottom: 12px;
            max-height: 100px;
            overflow-y: auto;
            position: relative;
        }
        
        .preset-prompt-copy {
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .preset-prompt-copy:hover {
            background-color: #f1f5f9;
            border-color: #cbd5e1;
        }
        
        .preset-prompt-copy::after {
            content: '点击复制';
            position: absolute;
            top: -25px;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }
        
        .preset-prompt-copy:hover::after {
            opacity: 1;
            visibility: visible;
        }
        
        .preset-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            min-width: 300px; /* 确保有足够的最小宽度 */
            flex-wrap: wrap;
            gap: 10px;
        }
        
        /* 确保评分和按钮区域在桌面端正确布局 */
        .preset-actions > div {
            flex-shrink: 0;
        }
        
        .preset-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #f59e0b;
            font-weight: 600;
        }
        
        .rating-stars {
            display: flex;
            gap: 2px;
            color: #f59e0b;
        }
        
        .star {
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .star:hover {
            color: #fbbf24;
        }
        
        .star.active {
            color: #f59e0b;
        }
        
        .preset-category {
            display: inline-block;
            padding: 2px 8px;
            background: #f1f5f9;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            color: #64748b;
            margin-right: 8px;
        }
        
        .preset-favorite {
            position: absolute;
            top: 16px;
            right: 16px;
            cursor: pointer;
            color: #e2e8f0;
            transition: all 0.2s ease;
        }
        
        .preset-favorite:hover {
            color: #ef4444;
        }
        
        .preset-favorite.favorited {
            color: #ef4444;
        }
        
        .color-preview {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .category-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }
        
        .category-item:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        
        .category-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .category-actions {
            display: flex;
            gap: 4px;
        }
        
        .empty-state {
            text-align: center;
            padding: 32px;
            color: #64748b;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            color: #cbd5e1;
        }
        
        .empty-state p {
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .empty-state small {
            font-size: 12px;
            color: #94a3b8;
        }
        
        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* 解析标签样式 - 修复：已存在标签为灰色，新标签为红色 */
        .parsed-tag {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
            color: #0c4a6e;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            padding: 4px 8px;
            margin: 2px;
            display: inline-block;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .parsed-tag:hover {
            background: linear-gradient(135deg, #bae6fd 0%, #7dd3fc 100%);
            transform: translateY(-1px);
        }
        
        .parsed-tag.existing {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #4b5563;
            border-color: #d1d5db;
        }
        
        .parsed-tag.new {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border-color: #ef4444;
        }
        
        /* 粘贴解析区域样式 */
        #pasteArea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* 解析结果区域样式 */
        #parsedTagsContainer {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 12px;
            padding: 8px;
            background: #f8fafc;
            border: 2px dashed #e2e8f0;
            border-radius: 8px;
        }
        
        /* 优化：标签页容器样式 - 支持水平滚动并隐藏滚动条 */
        #tagTabContainer {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
            scroll-behavior: smooth;
        }
        
        /* 隐藏滚动条但保留滚动功能 */
        #tagTabContainer::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }
        
        /* 修复：标签容器样式 */
        .tags-scroll-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
        }
        
        /* 优化：预设标签页容器样式 - 支持水平滚动并隐藏滚动条 */
        #presetTabContainer {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
            scroll-behavior: smooth;
        }
        
        /* 隐藏滚动条但保留滚动功能 */
        #presetTabContainer::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }
        
        /* 修复：预设内容区域样式 */
        .presets-scroll-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
        }
        
        /* 修复：模态框内部滚动 */
        .modal-content {
            max-height: calc(80vh - 120px);
            overflow-y: auto;
        }
        
        /* 优化：按钮间距 */
        .btn + .btn {
            margin-left: 4px;
        }
        
        /* 优化：确保标签按钮在容器中正常显示 */
        .tab-button {
            flex-shrink: 0;
            /* 保留原有样式，确保按钮不会被压缩 */
        }
        
        /* 修复：组标题样式 */
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .group-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .group-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #64748b;
        }
        
        .group-count {
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        /* 修复：已选择标签样式 */
        .selected-tag-content {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .selected-tag-text {
            font-weight: 600;
            color: #1e293b;
            font-size: 12px;
        }
        
        .selected-tag-name {
            font-size: 10px;
            color: #64748b;
            font-style: italic;
        }
        
        /* 权重显示已移除 */
        
        /* 修复：组内分组样式 */
        .sub-group {
            margin-left: 16px;
            padding-left: 16px;
            border-left: 2px solid #e2e8f0;
        }
        
        /* 修复：R18标签样式 */
        .tag-item.r18-tag {
            border: 2px solid #db2777;
            position: relative;
        }
        
        .tag-item.r18-tag::before {
            content: 'R18';
            position: absolute;
            top: -8px;
            right: -8px;
            background: #db2777;
            color: white;
            font-size: 8px;
            font-weight: 600;
            padding: 2px 4px;
            border-radius: 4px;
            z-index: 20;
        }
        
        /* 修复：置顶标签样式 */
        .tag-item.pinned {
            border: 2px solid #ef4444;
        }
        
        /* 修复：收藏标签样式 */
        .tag-item.favorited {
            border: 2px solid #f59e0b;
        }
        
        /* 修复：已选择标签样式 */
        .tag-item.selected {
            border: 2px solid #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }
        
        /* 修复：新增标签模态框样式 */
        #newTagModal .form-group {
            margin-bottom: 16px;
        }
        
        #newTagModal label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        #newTagModal input,
        #newTagModal select,
        #newTagModal textarea {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        #newTagModal input:focus,
        #newTagModal select:focus,
        #newTagModal textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        /* 修复：数据管理模态框样式 */
        #dataManagementModal .modal-content {
            padding: 0;
        }
        
        .data-option {
            padding: 16px;
            border-bottom: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .data-option:hover {
            background: #f8fafc;
        }
        
        .data-option:last-child {
            border-bottom: none;
        }
        
        .data-option-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }
        
        .data-option-description {
            font-size: 14px;
            color: #64748b;
        }
        
        /* 修复：导入选项样式 */
        #importOptions {
            display: none;
            padding: 16px;
            background: #f8fafc;
            border: 2px dashed #e2e8f0;
            border-radius: 8px;
            margin-top: 16px;
            text-align: center;
        }
        
        #importOptions.show {
            display: block;
        }
        
        #importOptions p {
            margin-bottom: 16px;
            color: #64748b;
        }
        
        /* 修复：加载状态样式 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-indicator {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        
        .loading-indicator.show {
            display: flex;
        }
        
        /* 修复：提示词文本框样式 */
        #positivePrompt {
            min-height: 100px;
            resize: vertical;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.5;
        }
        
        /* 修复：已选择标签容器样式 */
        #selectedTags {
            min-height: 70px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
        
        /* 标签滚动容器样式 */
        .tags-scroll-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: linear-gradient(to bottom, #ffffff, #f9fafb);
            border-radius: 8px;
        }
        
        /* 预设滚动容器样式 */
        .presets-scroll-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: linear-gradient(to bottom, #ffffff, #f9fafb);
            border-radius: 8px;
        }
        
        /* 修复：标签页按钮激活状态 */
        .tab-button.active {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%) !important;
            color: white !important;
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        /* 修复：R18标签页激活状态 */
        .tab-button.r18-tab.active {
            background: linear-gradient(135deg, #db2777 0%, #be185d 100%) !important;
            color: white !important;
            border-color: rgba(255, 255, 255, 0.3);
        }
        /* 建议下拉样式 */
        .suggestion-dropdown { position: absolute; top: 100%; left: 0; right: 0; z-index: 50; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 8px 20px rgba(0,0,0,0.12); margin-top: 4px; max-height: 240px; overflow-y: auto; }
        .suggestion-item { display:flex; justify-content: space-between; align-items: center; padding: 8px 10px; cursor:pointer; font-size: 12px; border-bottom: 1px solid #f1f5f9; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background:#f8fafc; }
        .suggestion-primary { font-weight:600; color:#1e293b; }
        .suggestion-secondary { color:#64748b; margin-left:8px; }
        .suggestion-empty { padding:10px; color:#94a3b8; text-align:center; font-size:12px; }
    </style>
</head>
<body class="min-h-screen py-6 px-4">
    <div class="max-w-7xl mx-auto">
        <!-- 主标题 -->
        <h1 class="main-title">Mayi Prompt UI</h1>
        <p class="subtitle">提示词管理工具 - 支持数据导出导入和本地存储</p>
        
        <!-- 已选择标签区域 -->
        <div class="app-card">
            <div class="title-bar">
                <h3 class="section-title">
                    <i class="fas fa-tags text-primary mr-2"></i> 已选择标签
                </h3>
                <div class="title-actions">
                    <div class="flex flex-wrap gap-2">
                        <button id="togglePlusMinus" class="btn btn-primary">
                            <i class="fas fa-plus-minus"></i> 加减号
                        </button>
                        <button id="toggleDelete" class="btn btn-warning">
                            <i class="fas fa-trash"></i> 删除X
                        </button>
                        <button id="clearAllBtn" class="btn btn-danger">
                            <i class="fas fa-broom"></i> 清空
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="selectedTags" class="tags-container min-h-[70px] p-3 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl border-2 border-dashed border-gray-300">
                <p class="text-gray-400 text-center w-full self-center py-3">点击下方标签添加到这里...</p>
            </div>
        </div>
        
        <!-- 生成的提示词区域 -->
        <div class="app-card">
            <h3 class="text-xl font-semibold mb-4">
                <i class="fas fa-magic text-primary mr-2"></i> 生成的提示词
            </h3>
            <div class="flex gap-2">
                <textarea id="positivePrompt" class="flex-1 w-full px-3 py-2 bg-gradient-to-br from-white to-gray-50 border-2 border-purple-200 resize-none min-h-[100px] rounded-md focus:outline-none focus:ring-2 focus:ring-purple-300 focus:border-purple-300" placeholder="在此粘贴提示词，系统会自动解析..."></textarea>
                <div class="flex flex-col gap-2">
                    <button id="pasteAnalyzeBtn" class="btn btn-info">
                        <i class="fas fa-magic"></i> 解析粘贴
                    </button>
                    <button id="copyPrompt" class="btn btn-primary">
                        <i class="fas fa-copy"></i> 复制
                    </button>
                    <button id="downloadPrompt" class="btn btn-success">
                        <i class="fas fa-download"></i> 下载
                    </button>
                </div>
            </div>
            <!-- 解析结果显示区域 -->
            <div id="parsedTagsContainer" style="display: none;"></div>
        </div>
        
        <!-- 标签管理区域 -->
        <div class="app-card">
            <div class="title-bar">
                <h3 id="tagManagementHeader" class="section-title">
                    <i class="fas fa-tags text-primary mr-2"></i> 标签管理
                </h3>
                <div class="title-actions">
                    <!-- 标签搜索框 -->
                    <div class="relative mr-2">
                        <input type="text" id="tagSearchInput" class="w-48 px-4 py-1 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="搜索标签...">
                        <span class="absolute right-3 text-gray-400" style="top:50%; transform: translateY(-55%);">
                            <i class="fas fa-search text-xs"></i>
                        </span>
                    </div>
                    <button id="editModeBtn" class="btn btn-secondary">
                        <i class="fas fa-edit"></i> 编辑模式
                    </button>
                    <button id="manageMainCategoriesBtn" class="btn btn-info">
                        <i class="fas fa-th-large"></i> 分类管理
                    </button>
                </div>
            </div>
            
            <!-- 移动端分组列表切换按钮 -->
            <div class="mb-2 flex justify-between items-center">
                <div class="flex gap-1 overflow-x-auto" id="tagTabContainer">
                    <!-- 标签分类标签页将通过JavaScript动态生成 -->
                </div>
                <button id="toggleGroupList" class="btn btn-sm btn-outline-primary ml-2 whitespace-nowrap">
                    <i class="fas fa-list"></i> <span>显示分组列表</span>
                </button>
            </div>
            
            <!-- 标签管理主容器 -->
            <div class="flex gap-4">
                <!-- 左侧分组侧边栏 -->
                <div id="tagSidebar" class="hidden md:block w-64 bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <div class="p-3 bg-gradient-to-r from-gray-100 to-gray-200">
                        <h4 class="font-medium text-gray-700">分组列表</h4>
                    </div>
                    <div id="groupList" class="p-2 max-h-[400px] overflow-y-auto">
                        <!-- 分组列表将通过JavaScript动态生成 -->
                    </div>
                </div>
                
                <!-- 右侧标签内容区域 -->
                <div id="tagsContent" class="tags-scroll-container flex-1">
                    <!-- 加载指示器 -->
                    <div id="tagsLoadingIndicator" class="loading-indicator hidden flex justify-center items-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                        <span class="ml-2 text-gray-600">加载中...</span>
                    </div>
                    <!-- 标签将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- Prompt管理区域 -->
        <div class="app-card">
            <div class="title-bar">
                <h3 class="section-title">
                    <i class="fas fa-cogs text-primary"></i> Prompt管理
                </h3>
                <div class="title-actions">
                    <!-- Prompt搜索框 -->
                    <div class="relative mr-2">
                        <input type="text" id="presetSearchInput" class="w-48 px-4 py-1 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="搜索Prompt...">
                        <span class="absolute right-3 text-gray-400" style="top:50%; transform: translateY(-55%);">
                            <i class="fas fa-search text-xs"></i>
                        </span>
                    </div>
                    <button id="newPresetBtn" class="btn btn-success">
                        <i class="fas fa-plus"></i> 新建Prompt
                    </button>
                    <button id="managePresetCategoriesBtn" class="btn btn-info">
                        <i class="fas fa-th-large"></i> 分类管理
                    </button>
                </div>
            </div>
            
            <!-- Prompt标签页 -->
            <div class="mb-4">
                <div class="flex gap-1 overflow-x-auto" id="presetTabContainer">
                    <!-- Prompt标签页将通过JavaScript动态生成 -->
                </div>
            </div>
            
            <!-- Prompt内容区域 -->
            <div id="presetContent" class="presets-scroll-container grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                <!-- 加载指示器 -->
                <div id="presetLoadingIndicator" class="loading-indicator hidden flex justify-center items-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    <span class="ml-2 text-gray-600">加载中...</span>
                </div>
                <!-- Prompt将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- 模态框 -->
    <!-- 编辑标签模态框 -->
    <div id="editTagModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">
                <i class="fas fa-edit mr-2"></i> 编辑标签
            </div>
            <div class="modal-content">
                <input type="hidden" id="editTagId">
                <input type="hidden" id="editTagCategory">
                <div class="form-group">
                    <label for="editTagName">标签名称</label>
                    <input type="text" id="editTagName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入标签名称">
                </div>
                <div class="form-group">
                    <label for="editTagText">标签文本</label>
                    <input type="text" id="editTagText" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入标签文本">
                </div>
                <div class="form-group">
                    <label for="editTagColor">标签颜色</label>
                    <input type="color" id="editTagColor" class="w-full h-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="form-group">
                    <label for="editTagGroup">所属分组</label>
                    <select id="editTagGroup" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">请选择分组</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editTagAllowPin"> 允许置顶
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editTagAllowFavorite"> 允许收藏
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelEditTagBtn" class="btn btn-secondary">取消</button>
                <button id="confirmEditTagBtn" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 新建标签模态框 -->
    <div id="newTagModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">
                <i class="fas fa-plus mr-2"></i> 新建标签
            </div>
            <div class="modal-content">
                <input type="hidden" id="newTagCategory">
                <input type="hidden" id="newTagGroup">
                <div class="form-group">
                    <label for="newTagName">标签名称</label>
                    <input type="text" id="newTagName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入标签名称">
                </div>
                <div class="form-group">
                    <label for="newTagText">标签文本</label>
                    <input type="text" id="newTagText" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入标签文本">
                </div>
                <div class="form-group">
                    <label for="newTagColor">标签颜色</label>
                    <input type="color" id="newTagColor" class="w-full h-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="form-group">
                    <label for="newTagGroupSelect">所属分组</label>
                    <select id="newTagGroupSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">请选择分组</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="newTagAllowPin" checked> 允许置顶
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="newTagAllowFavorite" checked> 允许收藏
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelNewTagBtn" class="btn btn-secondary">取消</button>
                <button id="confirmNewTagBtn" class="btn btn-primary">创建</button>
            </div>
        </div>
    </div>
    
    <!-- 解析新建标签模态框 -->
    <div id="parseNewTagModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">
                <i class="fas fa-plus mr-2"></i> 新建标签
            </div>
            <div class="modal-content">
                <input type="hidden" id="parseTagText">
                <div class="form-group">
                    <label for="parseTagName">标签名称（中文）</label>
                    <input type="text" id="parseTagName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入标签的中文名称">
                </div>
                <div class="form-group">
                    <label for="parseTagCategory">所属分类</label>
                    <select id="parseTagCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">请选择分类</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="parseTagGroup">所属分组</label>
                    <select id="parseTagGroup" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="default">默认分组</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="parseTagColor">标签颜色</label>
                    <input type="color" id="parseTagColor" class="w-full h-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value="#8B5CF6">
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelParseTagBtn" class="btn btn-secondary">取消</button>
                <button id="confirmParseTagBtn" class="btn btn-primary">创建</button>
            </div>
        </div>
    </div>
    
    <!-- 新建分组模态框 -->
    <div id="newGroupModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">
                <i class="fas fa-plus mr-2"></i> 新建分组
            </div>
            <div class="modal-content">
                <input type="hidden" id="newGroupCategory">
                <input type="hidden" id="newGroupParent">
                <div class="form-group">
                    <label for="newGroupName">分组名称</label>
                    <input type="text" id="newGroupName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入分组名称">
                </div>
                <div class="form-group">
                    <label for="newGroupDescription">分组描述</label>
                    <textarea id="newGroupDescription" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入分组描述" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelNewGroupBtn" class="btn btn-secondary">取消</button>
                <button id="confirmNewGroupBtn" class="btn btn-primary">创建</button>
            </div>
        </div>
    </div>
    
    <!-- 主分类管理模态框 -->
    <div id="mainCategoryManagementModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">
                <i class="fas fa-th-large mr-2"></i> 主分类管理
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label for="newMainCategoryName">新分类名称</label>
                    <div class="flex gap-2">
                        <input type="text" id="newMainCategoryName" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入分类名称">
                        <button id="addMainCategoryBtn" class="btn btn-primary">添加</button>
                    </div>
                </div>
                <div id="mainCategoryList" class="mt-4">
                    <!-- 主分类列表将通过JavaScript动态生成 -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeMainCategoryManagementBtn" class="btn btn-secondary">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- Prompt分类管理模态框 -->
    <div id="presetCategoryManagementModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">
                <i class="fas fa-th-large mr-2"></i> Prompt分类管理
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label for="newPresetCategoryName">新分类名称</label>
                    <div class="flex gap-2">
                        <input type="text" id="newPresetCategoryName" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入分类名称">
                        <button id="addPresetCategoryBtn" class="btn btn-primary">添加</button>
                    </div>
                </div>
                <div id="presetCategoryList" class="mt-4">
                    <!-- Prompt分类列表将通过JavaScript动态生成 -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="closePresetCategoryManagementBtn" class="btn btn-secondary">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 新建Prompt模态框 -->
    <div id="newPresetModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">
                <i class="fas fa-plus mr-2"></i> 新建Prompt
            </div>
            <div class="modal-content">
                <div class="form-group">
                    <label for="newPresetName">Prompt名称</label>
                    <input type="text" id="newPresetName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入Prompt名称">
                </div>
                <div class="form-group">
                    <label for="newPresetDescription">Prompt描述</label>
                    <textarea id="newPresetDescription" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入Prompt描述" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="newPresetCategory">所属分类</label>
                    <select id="newPresetCategory" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">请选择分类</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="newPresetPrompt">Prompt内容</label>
                    <textarea id="newPresetPrompt" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入Prompt内容" rows="5"></textarea>
                </div>
                <div class="form-group">
                    <label for="newPresetRating">评分</label>
                    <div class="rating-stars" id="newPresetRatingStars">
                        <span class="star" data-rating="1"><i class="fas fa-star"></i></span>
                        <span class="star" data-rating="2"><i class="fas fa-star"></i></span>
                        <span class="star" data-rating="3"><i class="fas fa-star"></i></span>
                        <span class="star" data-rating="4"><i class="fas fa-star"></i></span>
                        <span class="star" data-rating="5"><i class="fas fa-star"></i></span>
                        <span class="star" data-rating="6"><i class="fas fa-star"></i></span>
                        <span class="star" data-rating="7"><i class="fas fa-star"></i></span>
                        <span class="star" data-rating="8"><i class="fas fa-star"></i></span>
                        <span class="star" data-rating="9"><i class="fas fa-star"></i></span>
                        <span class="star" data-rating="10"><i class="fas fa-star"></i></span>
                    </div>
                    <input type="hidden" id="newPresetRating" value="5">
                </div>
                <div class="form-group">
                    <label for="newPresetImage">图片预览</label>
                    <div class="image-upload-container">
                        <div id="newPresetImagePreview" class="image-preview">
                            <i class="fas fa-image"></i>
                            <span>点击上传图片或拖拽到此处</span>
                        </div>
                        <input type="file" id="newPresetImage" accept="image/*" style="display: none;">
                        <input type="hidden" id="newPresetImageData" value="">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelNewPresetBtn" class="btn btn-secondary">取消</button>
                <button id="confirmNewPresetBtn" class="btn btn-primary">创建</button>
            </div>
        </div>
    </div>
    
    <!-- 编辑Prompt模态框 -->
    <div id="editPresetModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">
                <i class="fas fa-edit mr-2"></i> 编辑Prompt
            </div>
            <div class="modal-content">
                <input type="hidden" id="editPresetId">
                <input type="hidden" id="editPresetCategory">
                <div class="form-group">
                    <label for="editPresetName">Prompt名称</label>
                    <input type="text" id="editPresetName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入Prompt名称">
                </div>
                <div class="form-group">
                    <label for="editPresetDescription">Prompt描述</label>
                    <textarea id="editPresetDescription" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入Prompt描述" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="editPresetCategorySelect">所属分类</label>
                    <select id="editPresetCategorySelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">请选择分类</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editPresetPrompt">Prompt内容</label>
                    <textarea id="editPresetPrompt" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入Prompt内容" rows="5"></textarea>
                </div>
                <div class="form-group">
                    <label for="editPresetRating">评分</label>
                    <div class="rating-stars" id="editPresetRatingStars">
                        <span class="star" data-rating="1"><i class="fas fa-star"></i></span>
                        <span class="star" data-rating="2"><i class="fas fa-star"></i></span>
                        <span class="star" data-rating="3"><i class="fas fa-star"></i></span>
                        <span class="star" data-rating="4"><i class="fas fa-star"></i></span>
                        <span class="star" data-rating="5"><i class="fas fa-star"></i></span>
                        <span class="star" data-rating="6"><i class="fas fa-star"></i></span>
                        <span class="star" data-rating="7"><i class="fas fa-star"></i></span>
                        <span class="star" data-rating="8"><i class="fas fa-star"></i></span>
                        <span class="star" data-rating="9"><i class="fas fa-star"></i></span>
                        <span class="star" data-rating="10"><i class="fas fa-star"></i></span>
                    </div>
                    <input type="hidden" id="editPresetRating" value="5">
                </div>
                <div class="form-group">
                    <label for="editPresetImage">图片预览</label>
                    <div class="image-upload-container">
                        <div id="editPresetImagePreview" class="image-preview">
                            <i class="fas fa-image"></i>
                            <span>点击上传图片或拖拽到此处</span>
                        </div>
                        <input type="file" id="editPresetImage" accept="image/*" style="display: none;">
                        <input type="hidden" id="editPresetImageData" value="">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelEditPresetBtn" class="btn btn-secondary">取消</button>
                <button id="confirmEditPresetBtn" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 数据管理模态框 -->
    <div id="dataManagementModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">
                <i class="fas fa-database mr-2"></i> 数据管理
            </div>
            <div class="modal-content">
                <div class="data-option" id="exportAllData">
                    <div class="data-option-title">
                        <i class="fas fa-download mr-2"></i> 导出所有数据
                    </div>
                    <div class="data-option-description">
                        将所有标签、分组、分类和Prompt数据导出为JSON文件
                    </div>
                </div>
                <div class="data-option" id="importAllData">
                    <div class="data-option-title">
                        <i class="fas fa-upload mr-2"></i> 导入所有数据
                    </div>
                    <div class="data-option-description">
                        从JSON文件导入所有数据，将覆盖现有数据
                    </div>
                </div>
                <div id="importOptions" class="import-options">
                    <p>请选择要导入的JSON文件：</p>
                    <input type="file" id="importFile" accept=".json">
                    <button id="cancelImportBtn" class="btn btn-secondary mt-4">取消导入</button>
                </div>
                <div class="data-option" id="resetAllData">
                    <div class="data-option-title">
                        <i class="fas fa-trash mr-2"></i> 重置所有数据
                    </div>
                    <div class="data-option-description">
                        清除所有数据并恢复到初始状态
                    </div>
                </div>
                <div class="data-option" id="showLocalStorageInfo">
                    <div class="data-option-title">
                        <i class="fas fa-info-circle mr-2"></i> 存储信息
                    </div>
                    <div class="data-option-description">
                        查看本地存储使用情况和数据统计
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeDataManagementBtn" class="btn btn-secondary">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 存储信息模态框 -->
    <div id="localStorageInfoModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">
                <i class="fas fa-info-circle mr-2"></i> 本地存储信息
            </div>
            <div class="modal-content">
                <div id="storageInfoContent">
                    <!-- 存储信息将通过JavaScript动态生成 -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="closeLocalStorageInfoBtn" class="btn btn-secondary">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 通知组件 -->
    <div id="notification" class="notification"></div>

    <script>
        // 全局设置对象
        let currentTagSearch = '';
        let currentPresetSearch = '';
        let settings = {
            showPlusMinus: true,
            weightSymbol: '()',
            showDelete: true,
            showR18Groups: false,
            showNegative: false,
            currentTab: 'favorites',
            currentPresetTab: 'anime',
            selectedTags: [],
            tags: {},
            groups: {},
            mainCategories: [],
            presetCategories: [],
            presets: {},
            tagEditingMode: false,
            favorites: [],
            parsedTags: []
        };

        // 默认数据
        const defaultMainCategories = [
            { id: 'favorites', name: '收藏', color: '#f59e0b', isSystem: false },
            { id: 'quality', name: '角色', color: '#dc2626', isSystem: false },
            { id: 'style', name: '形象', color: '#2563eb', isSystem: false },
            { id: 'character', name: '姿态', color: '#059669', isSystem: false },
            { id: 'environment', name: '服饰', color: '#7c3aed', isSystem: false },
            { id: 'lighting', name: '服装', color: '#ea580c', isSystem: false },
            { id: 'details', name: '效果', color: '#0891b2', isSystem: false },
            { id: 'negative', name: '风格', color: '#4b5563', isSystem: false },
            { id: 'custom', name: '视角', color: '#d97706', isSystem: false },
            { id: 'r18', name: 'R18', color: '#db2777', isSystem: false }
        ];

        const defaultGroups = {
            quality: [
                { id: 'default', name: '默认分组', description: '默认分组' }
            ],
            style: [
                { id: 'default', name: '默认分组', description: '默认分组' }
            ],
            character: [
                { id: 'pose_static', name: '姿态（静止）', description: '静止姿态相关' },
                { id: 'movement', name: '移动（整体）', description: '整体移动动作' },
                { id: 'upper_limb', name: '上肢动作', description: '上肢相关动作' },
                { id: 'gestures_pointing', name: '手势与指向', description: '手势及指向类动作' },
                { id: 'hand_interaction', name: '手部交互', description: '手部交互动作' },
                { id: 'lower_limb', name: '下肢动作', description: '下肢相关动作' },
                { id: 'head_gaze', name: '头部与目光', description: '头部方向与目光' },
                { id: 'body_orientation', name: '身体方向与姿势', description: '身体方向与姿态' },
                { id: 'multi_person', name: '双人/多人互动', description: '多人互动动作' },
                { id: 'dance_performance', name: '舞蹈与表演', description: '舞蹈与表演姿态' }
            ],
            environment: [
                { id: 'default', name: '默认分组', description: '默认分组' }
            ],
            lighting: [
                { id: 'default', name: '默认分组', description: '默认分组' }
            ],
            details: [
                { id: 'lighting_effects', name: '光效与照明', description: '光照类型与光效' },
                { id: 'color_tone', name: '色彩与色调', description: '色彩分级与色调风格' },
                { id: 'particles_energy', name: '粒子与能量', description: '粒子、能量束、冲击波' },
                { id: 'weather_nature', name: '天气与自然', description: '自然天气与环境特效' },
                { id: 'motion_blur', name: '动态与模糊', description: '运动/景深/模糊类效果' },
                { id: 'textures_overlays', name: '纹理与叠加', description: '纹理、叠加与后期效果' },
                { id: 'shadows_reflections', name: '影子与反射', description: '阴影、反射与折射' },
                { id: 'glow_fluorescence', name: '发光与荧光', description: '发光、荧光与霓虹' }
            ],
            negative: [
                { id: 'default', name: '默认分组', description: '默认分组' }
            ],
            custom: [
                { id: 'default', name: '默认分组', description: '默认分组' }
            ],
            r18: [
                { id: 'default', name: '默认分组', description: '默认分组' }
            ]
        };

        const defaultTags = {
            quality: [
                { id: 'q1', name: '女孩', text: '1girl', color: '#dc2626', group: 'default', pinned: true, allowPin: true, allowFavorite: true },
                { id: 'q2', name: '男孩', text: '1boy', color: '#dc2626', group: 'default', pinned: true, allowPin: true, allowFavorite: true },
                { id: 'q3', name: '单人', text: 'solo', color: '#dc2626', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'q4', name: '萝莉', text: 'loli', color: '#dc2626', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'q5', name: '雌小鬼', text: 'mesugaki', color: '#dc2626', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'q6', name: '成熟女性', text: 'mature female', color: '#dc2626', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'q7', name: '痴女', text: 'female pervert', color: '#dc2626', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'q8', name: 'Q版', text: 'chibi', color: '#dc2626', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'q9', name: '男人', text: 'male', color: '#dc2626', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'q10', name: '学生', text: 'student', color: '#dc2626', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'q11', name: '妖精', text: 'elf', color: '#dc2626', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'q12', name: '兽人', text: 'furry', color: '#dc2626', group: 'default', allowPin: true, allowFavorite: true }
            ],
            style: [
                { id: 's1', name: '动漫', text: 'anime', color: '#2563eb', group: 'default', pinned: true, allowPin: true, allowFavorite: true },
                { id: 's2', name: '漫画', text: 'manga', color: '#2563eb', group: 'default', pinned: true, allowPin: true, allowFavorite: true },
                { id: 's3', name: '写实', text: 'realistic', color: '#2563eb', group: 'default', allowPin: true, allowFavorite: true },
                { id: 's4', name: '半写实', text: 'semi-realistic', color: '#2563eb', group: 'default', allowPin: true, allowFavorite: true },
                { id: 's5', name: '插画', text: 'illustration', color: '#2563eb', group: 'default', allowPin: true, allowFavorite: true },
                { id: 's6', name: '水彩', text: 'watercolor', color: '#2563eb', group: 'default', allowPin: true, allowFavorite: true },
                { id: 's7', name: '油画', text: 'oil painting', color: '#2563eb', group: 'default', allowPin: true, allowFavorite: true },
                { id: 's8', name: '素描', text: 'sketch', color: '#2563eb', group: 'default', allowPin: true, allowFavorite: true },
                { id: 's9', name: '卡通', text: 'cartoon', color: '#2563eb', group: 'default', allowPin: true, allowFavorite: true },
                { id: 's10', name: '3D渲染', text: '3d render', color: '#2563eb', group: 'default', allowPin: true, allowFavorite: true }
            ],
            character: [
                { id: 'c1', name: '站立', text: 'standing', color: '#059669', group: 'pose_static', allowPin: true, allowFavorite: true },
                { id: 'c2', name: '坐着', text: 'sitting', color: '#059669', group: 'pose_static', allowPin: true, allowFavorite: true },
                { id: 'c3', name: '跪姿', text: 'kneeling', color: '#059669', group: 'pose_static', allowPin: true, allowFavorite: true },
                { id: 'c4', name: '蹲姿', text: 'crouching', color: '#059669', group: 'pose_static', allowPin: true, allowFavorite: true },
                { id: 'c5', name: '仰卧', text: 'lying', color: '#059669', group: 'pose_static', allowPin: true, allowFavorite: true },
                { id: 'c6', name: '俯卧', text: 'prone', color: '#059669', group: 'pose_static', allowPin: true, allowFavorite: true },
                { id: 'c7', name: '倚靠', text: 'leaning', color: '#059669', group: 'pose_static', allowPin: true, allowFavorite: true },
                { id: 'c8', name: '盘腿', text: 'cross-legged', color: '#059669', group: 'pose_static', allowPin: true, allowFavorite: true },
                { id: 'c9', name: '行走', text: 'walking', color: '#059669', group: 'movement', allowPin: true, allowFavorite: true },
                { id: 'c10', name: '奔跑', text: 'running', color: '#059669', group: 'movement', allowPin: true, allowFavorite: true },
                { id: 'c11', name: '冲刺', text: 'sprinting', color: '#059669', group: 'movement', allowPin: true, allowFavorite: true },
                { id: 'c12', name: '跳跃', text: 'jumping', color: '#059669', group: 'movement', allowPin: true, allowFavorite: true },
                { id: 'c13', name: '单脚跳', text: 'hopping', color: '#059669', group: 'movement', allowPin: true, allowFavorite: true },
                { id: 'c14', name: '攀爬', text: 'climbing', color: '#059669', group: 'movement', allowPin: true, allowFavorite: true },
                { id: 'c15', name: '下落', text: 'falling', color: '#059669', group: 'movement', allowPin: true, allowFavorite: true },
                { id: 'c16', name: '翻滚', text: 'rolling', color: '#059669', group: 'movement', allowPin: true, allowFavorite: true },
                { id: 'c17', name: '举手', text: 'raise hand', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c18', name: '挥手', text: 'waving', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c19', name: '抱臂', text: 'arms crossed', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c20', name: '叉腰', text: 'hands on hips', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c21', name: '伸手', text: 'reach out', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c22', name: '耸肩', text: 'shrugging', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c23', name: '背手', text: 'hands behind back', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c24', name: '手臂伸展', text: 'arm stretch', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c25', name: '指向', text: 'pointing', color: '#059669', group: 'gestures_pointing', allowPin: true, allowFavorite: true },
                { id: 'c26', name: '剪刀手', text: 'peace sign', color: '#059669', group: 'gestures_pointing', allowPin: true, allowFavorite: true },
                { id: 'c27', name: 'OK 手势', text: 'ok gesture', color: '#059669', group: 'gestures_pointing', allowPin: true, allowFavorite: true },
                { id: 'c28', name: '竖大拇指', text: 'thumbs up', color: '#059669', group: 'gestures_pointing', allowPin: true, allowFavorite: true },
                { id: 'c29', name: '倒拇指', text: 'thumbs down', color: '#059669', group: 'gestures_pointing', allowPin: true, allowFavorite: true },
                { id: 'c30', name: '比心', text: 'heart hands', color: '#059669', group: 'gestures_pointing', allowPin: true, allowFavorite: true },
                { id: 'c31', name: '招手', text: 'beckoning', color: '#059669', group: 'gestures_pointing', allowPin: true, allowFavorite: true },
                { id: 'c32', name: '敬礼', text: 'salute', color: '#059669', group: 'gestures_pointing', allowPin: true, allowFavorite: true },
                { id: 'c33', name: '抓', text: 'grabbing', color: '#059669', group: 'hand_interaction', allowPin: true, allowFavorite: true },
                { id: 'c34', name: '握', text: 'holding', color: '#059669', group: 'hand_interaction', allowPin: true, allowFavorite: true },
                { id: 'c35', name: '推', text: 'pushing', color: '#059669', group: 'hand_interaction', allowPin: true, allowFavorite: true },
                { id: 'c36', name: '拉', text: 'pulling', color: '#059669', group: 'hand_interaction', allowPin: true, allowFavorite: true },
                { id: 'c37', name: '投掷', text: 'throwing', color: '#059669', group: 'hand_interaction', allowPin: true, allowFavorite: true },
                { id: 'c38', name: '接住', text: 'catching', color: '#059669', group: 'hand_interaction', allowPin: true, allowFavorite: true },
                { id: 'c39', name: '鼓掌', text: 'clapping', color: '#059669', group: 'hand_interaction', allowPin: true, allowFavorite: true },
                { id: 'c40', name: '敲击', text: 'knocking', color: '#059669', group: 'hand_interaction', allowPin: true, allowFavorite: true },
                { id: 'c41', name: '踢', text: 'kicking', color: '#059669', group: 'lower_limb', allowPin: true, allowFavorite: true },
                { id: 'c42', name: '跺脚', text: 'stomping', color: '#059669', group: 'lower_limb', allowPin: true, allowFavorite: true },
                { id: 'c43', name: '踮脚', text: 'tiptoe', color: '#059669', group: 'lower_limb', allowPin: true, allowFavorite: true },
                { id: 'c44', name: '弓步', text: 'lunge', color: '#059669', group: 'lower_limb', allowPin: true, allowFavorite: true },
                { id: 'c45', name: '前跨', text: 'step forward', color: '#059669', group: 'lower_limb', allowPin: true, allowFavorite: true },
                { id: 'c46', name: '后退', text: 'step back', color: '#059669', group: 'lower_limb', allowPin: true, allowFavorite: true },
                { id: 'c47', name: '侧移', text: 'sidestep', color: '#059669', group: 'lower_limb', allowPin: true, allowFavorite: true },
                { id: 'c48', name: '单腿平衡', text: 'one-leg balance', color: '#059669', group: 'lower_limb', allowPin: true, allowFavorite: true },
                { id: 'c49', name: '左视', text: 'look left', color: '#059669', group: 'head_gaze', allowPin: true, allowFavorite: true },
                { id: 'c50', name: '右视', text: 'look right', color: '#059669', group: 'head_gaze', allowPin: true, allowFavorite: true },
                { id: 'c51', name: '仰视', text: 'look up', color: '#059669', group: 'head_gaze', allowPin: true, allowFavorite: true },
                { id: 'c52', name: '俯视', text: 'look down', color: '#059669', group: 'head_gaze', allowPin: true, allowFavorite: true },
                { id: 'c53', name: '侧目', text: 'side glance', color: '#059669', group: 'head_gaze', allowPin: true, allowFavorite: true },
                { id: 'c54', name: '歪头', text: 'head tilt', color: '#059669', group: 'head_gaze', allowPin: true, allowFavorite: true },
                { id: 'c55', name: '点头', text: 'nod', color: '#059669', group: 'head_gaze', allowPin: true, allowFavorite: true },
                { id: 'c56', name: '摇头', text: 'shake head', color: '#059669', group: 'head_gaze', allowPin: true, allowFavorite: true },
                { id: 'c57', name: '面向左', text: 'face left', color: '#059669', group: 'body_orientation', allowPin: true, allowFavorite: true },
                { id: 'c58', name: '面向右', text: 'face right', color: '#059669', group: 'body_orientation', allowPin: true, allowFavorite: true },
                { id: 'c59', name: '背对', text: 'back facing', color: '#059669', group: 'body_orientation', allowPin: true, allowFavorite: true },
                { id: 'c60', name: '侧身', text: 'profile pose', color: '#059669', group: 'body_orientation', allowPin: true, allowFavorite: true },
                { id: 'c61', name: '扭腰', text: 'twist waist', color: '#059669', group: 'body_orientation', allowPin: true, allowFavorite: true },
                { id: 'c62', name: '俯身', text: 'bend over', color: '#059669', group: 'body_orientation', allowPin: true, allowFavorite: true },
                { id: 'c63', name: '拱背', text: 'arched back', color: '#059669', group: 'body_orientation', allowPin: true, allowFavorite: true },
                { id: 'c64', name: '身体挺直', text: 'upright posture', color: '#059669', group: 'body_orientation', allowPin: true, allowFavorite: true },
                { id: 'c65', name: '拥抱', text: 'hugging', color: '#059669', group: 'multi_person', allowPin: true, allowFavorite: true },
                { id: 'c66', name: '牵手', text: 'holding hands', color: '#059669', group: 'multi_person', allowPin: true, allowFavorite: true },
                { id: 'c67', name: '击掌', text: 'high five', color: '#059669', group: 'multi_person', allowPin: true, allowFavorite: true },
                { id: 'c68', name: '碰肩', text: 'shoulder bump', color: '#059669', group: 'multi_person', allowPin: true, allowFavorite: true },
                { id: 'c69', name: '背靠背', text: 'back-to-back', color: '#059669', group: 'multi_person', allowPin: true, allowFavorite: true },
                { id: 'c70', name: '握手', text: 'handshake', color: '#059669', group: 'multi_person', allowPin: true, allowFavorite: true },
                { id: 'c71', name: '怀抱', text: 'carry in arms', color: '#059669', group: 'multi_person', allowPin: true, allowFavorite: true },
                { id: 'c72', name: '举起', text: 'lift up', color: '#059669', group: 'multi_person', allowPin: true, allowFavorite: true },
                { id: 'c73', name: '旋转', text: 'dance spin', color: '#059669', group: 'dance_performance', allowPin: true, allowFavorite: true },
                { id: 'c74', name: '足尖姿势', text: 'en pointe', color: '#059669', group: 'dance_performance', allowPin: true, allowFavorite: true },
                { id: 'c75', name: '摆胯', text: 'hip sway', color: '#059669', group: 'dance_performance', allowPin: true, allowFavorite: true },
                { id: 'c76', name: '摆臂舞', text: 'arm wave dance', color: '#059669', group: 'dance_performance', allowPin: true, allowFavorite: true },
                { id: 'c77', name: '鞠躬', text: 'bow', color: '#059669', group: 'dance_performance', allowPin: true, allowFavorite: true },
                { id: 'c78', name: '屈膝礼', text: 'curtsy', color: '#059669', group: 'dance_performance', allowPin: true, allowFavorite: true },
                { id: 'c79', name: '芭蕾跳', text: 'ballet jump', color: '#059669', group: 'dance_performance', allowPin: true, allowFavorite: true },
                { id: 'c80', name: '戏剧化造型', text: 'dramatic pose', color: '#059669', group: 'dance_performance', allowPin: true, allowFavorite: true },
                { id: 'c81', name: 'T 形站姿', text: 't-pose', color: '#059669', group: 'pose_static', allowPin: true, allowFavorite: true },
                { id: 'c82', name: 'A 形站姿', text: 'a-pose', color: '#059669', group: 'pose_static', allowPin: true, allowFavorite: true },
                { id: 'c83', name: '平板支撑', text: 'plank', color: '#059669', group: 'pose_static', allowPin: true, allowFavorite: true },
                { id: 'c84', name: '桥式', text: 'bridge pose', color: '#059669', group: 'pose_static', allowPin: true, allowFavorite: true },
                { id: 'c85', name: '劈叉', text: 'split', color: '#059669', group: 'pose_static', allowPin: true, allowFavorite: true },
                { id: 'c86', name: '倒立', text: 'handstand', color: '#059669', group: 'pose_static', allowPin: true, allowFavorite: true },
                { id: 'c87', name: '头倒立', text: 'headstand', color: '#059669', group: 'pose_static', allowPin: true, allowFavorite: true },
                { id: 'c88', name: '靠墙', text: 'wall lean', color: '#059669', group: 'pose_static', allowPin: true, allowFavorite: true },
                { id: 'c89', name: '坐地', text: 'floor sit', color: '#059669', group: 'pose_static', allowPin: true, allowFavorite: true },
                { id: 'c90', name: '跪坐', text: 'on knees', color: '#059669', group: 'pose_static', allowPin: true, allowFavorite: true },
                { id: 'c91', name: '慢跑', text: 'jogging', color: '#059669', group: 'movement', allowPin: true, allowFavorite: true },
                { id: 'c92', name: '跳步', text: 'skipping', color: '#059669', group: 'movement', allowPin: true, allowFavorite: true },
                { id: 'c93', name: '行进', text: 'marching', color: '#059669', group: 'movement', allowPin: true, allowFavorite: true },
                { id: 'c94', name: '踮脚行走', text: 'tiptoeing', color: '#059669', group: 'movement', allowPin: true, allowFavorite: true },
                { id: 'c95', name: '滑行', text: 'sliding', color: '#059669', group: 'movement', allowPin: true, allowFavorite: true },
                { id: 'c96', name: '轻滑', text: 'gliding', color: '#059669', group: 'movement', allowPin: true, allowFavorite: true },
                { id: 'c97', name: '突进冲刺', text: 'dashing', color: '#059669', group: 'movement', allowPin: true, allowFavorite: true },
                { id: 'c98', name: '闪避', text: 'dodging', color: '#059669', group: 'movement', allowPin: true, allowFavorite: true },
                { id: 'c99', name: '原地转身', text: 'pivoting', color: '#059669', group: 'movement', allowPin: true, allowFavorite: true },
                { id: 'c100', name: '转身', text: 'turning', color: '#059669', group: 'movement', allowPin: true, allowFavorite: true },
                { id: 'c101', name: '双手插兜', text: 'hands in pockets', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c102', name: '双臂张开', text: 'arms open', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c103', name: '双臂展开', text: 'arms spread', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c104', name: '双臂过头', text: 'arms overhead', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c105', name: '双手抱头', text: 'hands behind head', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c106', name: '托腮', text: 'hand on chin', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c107', name: '扶脸', text: 'hand on cheek', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c108', name: '捂嘴', text: 'cover mouth', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c109', name: '遮眼', text: 'cover eyes', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c110', name: '扶额', text: 'hand on forehead', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c111', name: '振臂', text: 'fist pump', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c112', name: '紧握拳', text: 'clenched fist', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c113', name: '张开手掌', text: 'open palm', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c114', name: '手心向上', text: 'palm up', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c115', name: '手心向下', text: 'palm down', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c116', name: '手肘撑桌', text: 'elbow on table', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c117', name: '双臂叠放', text: 'arms folded', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c118', name: '双手合十', text: 'hands together', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c119', name: '双手交握', text: 'hands clasped', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c120', name: '弹指', text: 'finger snap', color: '#059669', group: 'upper_limb', allowPin: true, allowFavorite: true },
                { id: 'c121', name: '嘘手势', text: 'shush', color: '#059669', group: 'gestures_pointing', allowPin: true, allowFavorite: true },
                { id: 'c122', name: '手指枪', text: 'finger gun', color: '#059669', group: 'gestures_pointing', allowPin: true, allowFavorite: true },
                { id: 'c123', name: '摇滚手势', text: 'rock sign', color: '#059669', group: 'gestures_pointing', allowPin: true, allowFavorite: true },
                { id: 'c124', name: '打电话手势', text: 'call me', color: '#059669', group: 'gestures_pointing', allowPin: true, allowFavorite: true },
                { id: 'c125', name: '停止手势', text: 'stop hand', color: '#059669', group: 'gestures_pointing', allowPin: true, allowFavorite: true },
                { id: 'c126', name: '数字一手势', text: 'number one', color: '#059669', group: 'gestures_pointing', allowPin: true, allowFavorite: true },
                { id: 'c127', name: '数字二手势', text: 'number two', color: '#059669', group: 'gestures_pointing', allowPin: true, allowFavorite: true },
                { id: 'c128', name: '数字三手势', text: 'number three', color: '#059669', group: 'gestures_pointing', allowPin: true, allowFavorite: true },
                { id: 'c129', name: '圈指手势', text: 'circle gesture', color: '#059669', group: 'gestures_pointing', allowPin: true, allowFavorite: true },
                { id: 'c130', name: '向内招手', text: 'wave inward', color: '#059669', group: 'gestures_pointing', allowPin: true, allowFavorite: true },
                { id: 'c131', name: '捏', text: 'pinching', color: '#059669', group: 'hand_interaction', allowPin: true, allowFavorite: true },
                { id: 'c132', name: '挤压', text: 'squeezing', color: '#059669', group: 'hand_interaction', allowPin: true, allowFavorite: true },
                { id: 'c133', name: '提起', text: 'lifting', color: '#059669', group: 'hand_interaction', allowPin: true, allowFavorite: true },
                { id: 'c134', name: '放下', text: 'lowering', color: '#059669', group: 'hand_interaction', allowPin: true, allowFavorite: true },
                { id: 'c135', name: '递给', text: 'handing over', color: '#059669', group: 'hand_interaction', allowPin: true, allowFavorite: true },
                { id: 'c136', name: '接过', text: 'receiving', color: '#059669', group: 'hand_interaction', allowPin: true, allowFavorite: true },
                { id: 'c137', name: '搓手', text: 'rubbing hands', color: '#059669', group: 'hand_interaction', allowPin: true, allowFavorite: true },
                { id: 'c138', name: '按压', text: 'pressing', color: '#059669', group: 'hand_interaction', allowPin: true, allowFavorite: true },
                { id: 'c139', name: '高踢', text: 'high kick', color: '#059669', group: 'lower_limb', allowPin: true, allowFavorite: true },
                { id: 'c140', name: '抬膝', text: 'knee lift', color: '#059669', group: 'lower_limb', allowPin: true, allowFavorite: true }
            ],
            environment: [
                { id: 'e1', name: '户外', text: 'outdoor', color: '#7c3aed', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'e2', name: '室内', text: 'indoor', color: '#7c3aed', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'e3', name: '城市', text: 'city', color: '#7c3aed', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'e4', name: '乡村', text: 'countryside', color: '#7c3aed', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'e5', name: '森林', text: 'forest', color: '#7c3aed', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'e6', name: '海滩', text: 'beach', color: '#7c3aed', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'e7', name: '山脉', text: 'mountains', color: '#7c3aed', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'e8', name: '太空', text: 'space', color: '#7c3aed', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'e9', name: '学校', text: 'school', color: '#7c3aed', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'e10', name: '家庭', text: 'home', color: '#7c3aed', group: 'default', allowPin: true, allowFavorite: true }
            ],
            lighting: [
                { id: 'l1', name: '自然光', text: 'natural lighting', color: '#ea580c', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'l2', name: '人工光', text: 'artificial lighting', color: '#ea580c', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'l3', name: '柔和光', text: 'soft lighting', color: '#ea580c', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'l4', name: '硬光', text: 'hard lighting', color: '#ea580c', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'l5', name: '背光', text: 'backlighting', color: '#ea580c', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'l6', name: '侧光', text: 'side lighting', color: '#ea580c', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'l7', name: '顶光', text: 'top lighting', color: '#ea580c', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'l8', name: '底光', text: 'bottom lighting', color: '#ea580c', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'l9', name: '黄金时段', text: 'golden hour', color: '#ea580c', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'l10', name: '蓝调时段', text: 'blue hour', color: '#ea580c', group: 'default', allowPin: true, allowFavorite: true }
            ],
            details: [
                { id: 'd1', name: '逆光', text: 'backlighting', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd2', name: '边缘光', text: 'rim lighting', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd3', name: '动态光效', text: 'dynamic lighting', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd4', name: '柔光', text: 'soft lighting', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd5', name: '硬光', text: 'hard lighting', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd6', name: '侧光', text: 'side lighting', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd7', name: '顶光', text: 'top lighting', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd8', name: '底光', text: 'bottom lighting', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd9', name: '聚光灯', text: 'spotlight', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd10', name: '霓虹灯光', text: 'neon lighting', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd11', name: '环境光', text: 'ambient lighting', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd12', name: '暖光', text: 'warm lighting', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd13', name: '冷光', text: 'cool lighting', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd14', name: '戏剧性光效', text: 'dramatic lighting', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd15', name: '影棚光', text: 'studio lighting', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd16', name: '低调光', text: 'low-key lighting', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd17', name: '高调光', text: 'high-key lighting', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd18', name: '黄金时段', text: 'golden hour', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd19', name: '蓝调时段', text: 'blue hour', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd20', name: '神光束', text: 'god rays', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd21', name: '镜头眩光', text: 'lens flare', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd22', name: '泛光', text: 'bloom', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd23', name: '光条', text: 'light streaks', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd24', name: '光轨', text: 'light trails', color: '#0891b2', group: 'lighting_effects', allowPin: true, allowFavorite: true },
                { id: 'd25', name: '色彩分级', text: 'color grading', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd26', name: '单色', text: 'monochrome', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd27', name: '双重色调', text: 'duotone', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd28', name: '复古棕褐', text: 'sepia tone', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd29', name: '粉彩色调', text: 'pastel tones', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd30', name: '鲜艳色彩', text: 'vivid colors', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd31', name: '柔和色彩', text: 'muted colors', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd32', name: '高饱和', text: 'high saturation', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd33', name: '低饱和', text: 'low saturation', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd34', name: '高对比', text: 'high contrast', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd35', name: '低对比', text: 'low contrast', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd36', name: '色相偏移', text: 'hue shift', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd37', name: '色彩点映', text: 'color splash', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd38', name: '选择性色彩', text: 'selective color', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd39', name: '渐变', text: 'gradient', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd40', name: '渐变映射', text: 'gradient map', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd41', name: '颜色叠加', text: 'color overlay', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd42', name: '着色', text: 'tint', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd43', name: '去饱和', text: 'desaturation', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd44', name: '灰度', text: 'grayscale', color: '#0891b2', group: 'color_tone', allowPin: true, allowFavorite: true },
                { id: 'd45', name: '粒子', text: 'particles', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd46', name: '闪光颗粒', text: 'sparkles', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd47', name: '火花', text: 'sparks', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd48', name: '余烬', text: 'embers', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd49', name: '烟雾', text: 'smoke', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd50', name: '雾', text: 'fog', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd51', name: '薄雾', text: 'mist', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd52', name: '灰尘', text: 'dust', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd53', name: '雪花粒子', text: 'snow particles', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd54', name: '雨滴粒子', text: 'rain particles', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd55', name: '魔法阵', text: 'magic circle', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd56', name: '光环', text: 'aura', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd57', name: '能量场', text: 'energy field', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd58', name: '能量光束', text: 'energy beam', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd59', name: '光束', text: 'beam of light', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd60', name: '闪电', text: 'lightning', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd61', name: '雷电', text: 'thunderbolt', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd62', name: '冲击波', text: 'shockwave', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd63', name: '爆炸', text: 'explosion', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd64', name: '火球', text: 'fireball', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd65', name: '尾迹效果', text: 'trail effect', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd66', name: '星光粒子', text: 'star particles', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd67', name: '闪光轨迹', text: 'sparkle trail', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd68', name: '粒子喷发', text: 'particle burst', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd69', name: '发光粒子', text: 'glow particles', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd70', name: '霾', text: 'haze', color: '#0891b2', group: 'particles_energy', allowPin: true, allowFavorite: true },
                { id: 'd71', name: '阳光', text: 'sunlight', color: '#0891b2', group: 'weather_nature', allowPin: true, allowFavorite: true },
                { id: 'd72', name: '月光', text: 'moonlight', color: '#0891b2', group: 'weather_nature', allowPin: true, allowFavorite: true },
                { id: 'd73', name: '星空', text: 'starry sky', color: '#0891b2', group: 'weather_nature', allowPin: true, allowFavorite: true },
                { id: 'd74', name: '彩虹', text: 'rainbow', color: '#0891b2', group: 'weather_nature', allowPin: true, allowFavorite: true },
                { id: 'd75', name: '雨', text: 'rain', color: '#0891b2', group: 'weather_nature', allowPin: true, allowFavorite: true },
                { id: 'd76', name: '下雪', text: 'snowfall', color: '#0891b2', group: 'weather_nature', allowPin: true, allowFavorite: true },
                { id: 'd77', name: '暴雪', text: 'blizzard', color: '#0891b2', group: 'weather_nature', allowPin: true, allowFavorite: true },
                { id: 'd78', name: '毛毛雨', text: 'drizzle', color: '#0891b2', group: 'weather_nature', allowPin: true, allowFavorite: true },
                { id: 'd79', name: '风暴', text: 'storm', color: '#0891b2', group: 'weather_nature', allowPin: true, allowFavorite: true },
                { id: 'd80', name: '雷暴', text: 'thunderstorm', color: '#0891b2', group: 'weather_nature', allowPin: true, allowFavorite: true },
                { id: 'd81', name: '风效', text: 'wind effect', color: '#0891b2', group: 'weather_nature', allowPin: true, allowFavorite: true },
                { id: 'd82', name: '沙尘暴', text: 'sandstorm', color: '#0891b2', group: 'weather_nature', allowPin: true, allowFavorite: true },
                { id: 'd83', name: '日出', text: 'sunrise', color: '#0891b2', group: 'weather_nature', allowPin: true, allowFavorite: true },
                { id: 'd84', name: '日落', text: 'sunset', color: '#0891b2', group: 'weather_nature', allowPin: true, allowFavorite: true },
                { id: 'd85', name: '阴天', text: 'overcast', color: '#0891b2', group: 'weather_nature', allowPin: true, allowFavorite: true },
                { id: 'd86', name: '多云', text: 'cloudy', color: '#0891b2', group: 'weather_nature', allowPin: true, allowFavorite: true },
                { id: 'd87', name: '晴空', text: 'clear sky', color: '#0891b2', group: 'weather_nature', allowPin: true, allowFavorite: true },
                { id: 'd88', name: '运动模糊', text: 'motion blur', color: '#0891b2', group: 'motion_blur', allowPin: true, allowFavorite: true },
                { id: 'd89', name: '速度线', text: 'speed lines', color: '#0891b2', group: 'motion_blur', allowPin: true, allowFavorite: true },
                { id: 'd90', name: '拖影帧', text: 'smear frame', color: '#0891b2', group: 'motion_blur', allowPin: true, allowFavorite: true },
                { id: 'd91', name: '长曝光', text: 'long exposure', color: '#0891b2', group: 'motion_blur', allowPin: true, allowFavorite: true },
                { id: 'd92', name: '慢速快门', text: 'slow shutter', color: '#0891b2', group: 'motion_blur', allowPin: true, allowFavorite: true },
                { id: 'd93', name: '残像', text: 'afterimage', color: '#0891b2', group: 'motion_blur', allowPin: true, allowFavorite: true },
                { id: 'd94', name: '重影', text: 'ghosting', color: '#0891b2', group: 'motion_blur', allowPin: true, allowFavorite: true },
                { id: 'd95', name: '径向模糊', text: 'radial blur', color: '#0891b2', group: 'motion_blur', allowPin: true, allowFavorite: true },
                { id: 'd96', name: '变焦模糊', text: 'zoom blur', color: '#0891b2', group: 'motion_blur', allowPin: true, allowFavorite: true },
                { id: 'd97', name: '移轴模糊', text: 'tilt-shift blur', color: '#0891b2', group: 'motion_blur', allowPin: true, allowFavorite: true },
                { id: 'd98', name: '景深', text: 'depth of field', color: '#0891b2', group: 'motion_blur', allowPin: true, allowFavorite: true },
                { id: 'd99', name: '散景', text: 'bokeh', color: '#0891b2', group: 'motion_blur', allowPin: true, allowFavorite: true },
                { id: 'd100', name: '对焦模糊', text: 'focus blur', color: '#0891b2', group: 'motion_blur', allowPin: true, allowFavorite: true },
                { id: 'd101', name: '背景虚化', text: 'background blur', color: '#0891b2', group: 'motion_blur', allowPin: true, allowFavorite: true },
                { id: 'd102', name: '前景虚化', text: 'foreground blur', color: '#0891b2', group: 'motion_blur', allowPin: true, allowFavorite: true },
                { id: 'd103', name: '机位震动', text: 'camera shake', color: '#0891b2', group: 'motion_blur', allowPin: true, allowFavorite: true },
                { id: 'd104', name: '时间切片', text: 'time slice', color: '#0891b2', group: 'motion_blur', allowPin: true, allowFavorite: true },
                { id: 'd105', name: '定格画面', text: 'freeze frame', color: '#0891b2', group: 'motion_blur', allowPin: true, allowFavorite: true },
                { id: 'd106', name: '胶片颗粒', text: 'film grain', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd107', name: '噪点纹理', text: 'noise texture', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd108', name: '半色调', text: 'halftone', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd109', name: '抖动', text: 'dithering', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd110', name: '扫描线', text: 'scanlines', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd111', name: '显像管效果', text: 'CRT effect', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd112', name: '录像带效果', text: 'VHS effect', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd113', name: '故障效果', text: 'glitch', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd114', name: '变形扭曲', text: 'distortion', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd115', name: '色差', text: 'chromatic aberration', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd116', name: '暗角', text: 'vignette', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd117', name: '水彩效果', text: 'watercolor effect', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd118', name: '油画效果', text: 'oil paint effect', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd119', name: '速写效果', text: 'sketch effect', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd120', name: '像素化', text: 'pixelation', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd121', name: '马赛克', text: 'mosaic', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd122', name: '色阶分段', text: 'posterization', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd123', name: '网点贴图', text: 'comic screentone', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd124', name: '纸张纹理', text: 'paper texture', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd125', name: '墨迹晕染', text: 'ink bleed', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd126', name: '漏光', text: 'light leak', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd127', name: '灼印', text: 'burn-in', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd128', name: '双重曝光', text: 'double exposure', color: '#0891b2', group: 'textures_overlays', allowPin: true, allowFavorite: true },
                { id: 'd129', name: '强阴影', text: 'strong shadow', color: '#0891b2', group: 'shadows_reflections', allowPin: true, allowFavorite: true },
                { id: 'd130', name: '软阴影', text: 'soft shadow', color: '#0891b2', group: 'shadows_reflections', allowPin: true, allowFavorite: true },
                { id: 'd131', name: '投影', text: 'cast shadow', color: '#0891b2', group: 'shadows_reflections', allowPin: true, allowFavorite: true },
                { id: 'd132', name: '阴影投射', text: 'drop shadow', color: '#0891b2', group: 'shadows_reflections', allowPin: true, allowFavorite: true },
                { id: 'd133', name: '剪影', text: 'silhouette', color: '#0891b2', group: 'shadows_reflections', allowPin: true, allowFavorite: true },
                { id: 'd134', name: '反射', text: 'reflection', color: '#0891b2', group: 'shadows_reflections', allowPin: true, allowFavorite: true },
                { id: 'd135', name: '镜像反射', text: 'mirror reflection', color: '#0891b2', group: 'shadows_reflections', allowPin: true, allowFavorite: true },
                { id: 'd136', name: '折射', text: 'refraction', color: '#0891b2', group: 'shadows_reflections', allowPin: true, allowFavorite: true },
                { id: 'd137', name: '焦散', text: 'caustics', color: '#0891b2', group: 'shadows_reflections', allowPin: true, allowFavorite: true },
                { id: 'd138', name: '明暗对照', text: 'chiaroscuro', color: '#0891b2', group: 'shadows_reflections', allowPin: true, allowFavorite: true },
                { id: 'd139', name: '发光', text: 'glowing', color: '#0891b2', group: 'glow_fluorescence', allowPin: true, allowFavorite: true },
                { id: 'd140', name: '霓虹发光', text: 'neon glow', color: '#0891b2', group: 'glow_fluorescence', allowPin: true, allowFavorite: true }
            ],
            negative: [
                { id: 'n1', name: '低质量', text: 'low quality', color: '#4b5563', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'n2', name: '模糊', text: 'blurry', color: '#4b5563', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'n3', name: '像素化', text: 'pixelated', color: '#4b5563', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'n4', name: '变形', text: 'distorted', color: '#4b5563', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'n5', name: '不完整', text: 'incomplete', color: '#4b5563', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'n6', name: '错误', text: 'error', color: '#4b5563', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'n7', name: '水印', text: 'watermark', color: '#4b5563', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'n8', name: '签名', text: 'signature', color: '#4b5563', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'n9', name: '文字', text: 'text', color: '#4b5563', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'n10', name: '边框', text: 'border', color: '#4b5563', group: 'default', allowPin: true, allowFavorite: true }
            ],
            r18: [
                { id: 'r1', name: 'R18内容', text: 'nsfw', color: '#db2777', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'r2', name: '半裸', text: 'partial nudity', color: '#db2777', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'r3', name: '全裸', text: 'full nudity', color: '#db2777', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'r4', name: '性感', text: 'sexy', color: '#db2777', group: 'default', allowPin: true, allowFavorite: true },
                { id: 'r5', name: '诱惑', text: 'seductive', color: '#db2777', group: 'default', allowPin: true, allowFavorite: true }
            ]
        };

        const defaultPresetCategories = [
            { id: 'anime', name: '动漫风格', isSystem: false },
            { id: 'realistic', name: '写实风格', isSystem: false },
            { id: 'artistic', name: '艺术风格', isSystem: false },
            { id: 'portrait', name: '人像摄影', isSystem: false },
            { id: 'landscape', name: '风景摄影', isSystem: false },
            { id: 'custom', name: '自定义', isSystem: false }
        ];

        const defaultPresets = {
            anime: [
                {
                    id: 'p1',
                    name: '高质量动漫',
                    description: '经典动漫风格，高细节，鲜艳色彩',
                    prompt: 'masterpiece, best quality, anime, intricate details, beautiful girl, outdoor, dynamic lighting',
                    category: 'anime',
                    rating: 9,
                    favorite: false
                },
                {
                    id: 'p2',
                    name: '萌系动漫',
                    description: '可爱萌系风格，大眼睛，柔和色彩',
                    prompt: 'masterpiece, manga, cute girl, soft lighting, indoor, detailed background',
                    category: 'anime',
                    rating: 8,
                    favorite: false
                },
                {
                    id: 'p3',
                    name: '奇幻动漫',
                    description: '奇幻风格动漫，魔法元素丰富',
                    prompt: 'fantasy anime, magical girl, detailed background, dynamic lighting, high quality',
                    category: 'anime',
                    rating: 8,
                    favorite: false
                }
            ],
            realistic: [
                {
                    id: 'p4',
                    name: '写实人像',
                    description: '超写实人像摄影风格',
                    prompt: 'photorealistic, hyperdetailed, portrait photography, professional lighting, 8k',
                    category: 'realistic',
                    rating: 9,
                    favorite: false
                },
                {
                    id: 'p5',
                    name: '写实风景',
                    description: '写实风景摄影风格',
                    prompt: 'photorealistic landscape, natural lighting, detailed, 8k resolution',
                    category: 'realistic',
                    rating: 8,
                    favorite: false
                }
            ]
        };

        // 初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // 定义防抖函数
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
        
        // 全局变量用于搜索
        // 修复重复声明问题
        window.currentTagSearch = window.currentTagSearch || '';
        window.currentPresetSearch = window.currentPresetSearch || '';
        
        // 全局定义防抖搜索函数
        let debouncedTagSearch = debounce(function() {
            window.currentTagSearch = this.value.trim().toLowerCase();
            console.log('标签搜索关键词:', window.currentTagSearch);
            if (typeof renderTags === 'function') renderTags();
        }, 300);
        
        let debouncedPresetSearch = debounce(function() {
            window.currentPresetSearch = this.value.trim().toLowerCase();
            console.log('Prompt搜索关键词:', window.currentPresetSearch);
            if (typeof renderPresets === 'function') renderPresets();
        }, 300);
        
        function initializeApp() {
            console.log('开始初始化应用...');
            
            try {
                loadData();
            } catch (error) {
                console.error('加载数据时出错:', error);
            }
            
            // 优先从 CSV 同步五个分类（形象/style、姿态/character、效果/details、服装/lighting、R18/r18）
            try {
                if (typeof syncTagsFromCSV === 'function') {
                    // 形象（中文文件名，来自 tag 子目录）
                    syncTagsFromCSV('style', 'tag/人物.csv');
                    // 姿态（中文文件名，来自 tag 子目录）
                    syncTagsFromCSV('character', 'tag/动作.csv');
                    // 效果（中文文件名，来自 tag 子目录）
                    syncTagsFromCSV('details', 'tag/效果.csv');
                    // 风格（中文文件名，来自 tag 子目录）- 先清空原有标签，再从CSV同步
                    if (settings && settings.tags) settings.tags['negative'] = [];
                    if (settings && settings.groups) settings.groups['negative'] = [];
                    syncTagsFromCSV('negative', 'tag/风格.csv');
                    // 服装（中文文件名，来自 tag 子目录）- 先清空原有标签，再从CSV同步
                    if (settings && settings.tags) settings.tags['lighting'] = [];
                    if (settings && settings.groups) settings.groups['lighting'] = [];
                    syncTagsFromCSV('lighting', 'tag/服装.csv');
                    // R18 标签（中文文件名，来自 tag 子目录）- 先清空原有标签，再从CSV同步
                    if (settings && settings.tags) settings.tags['r18'] = [];
                    if (settings && settings.groups) settings.groups['r18'] = [];
                    syncTagsFromCSV('r18', 'tag/R18.csv');
                }
            } catch (error) {
                console.error('CSV 同步分类标签时出错:', error);
            }

            try {
                initializeEventListeners();
            } catch (error) {
                console.error('初始化事件监听器时出错:', error);
                // 添加空值检查到setupEventListeners函数
                function safeSetupEventListeners() {
                    try {
                        // 确保元素存在再添加事件监听器
                        const elements = {
                            pasteAnalyzeBtn: 'pasteAnalyzeBtn',
                            tagSearchInput: 'tagSearchInput',
                            presetSearchInput: 'presetSearchInput'
                        };
                        
                        // 检查并添加pasteAnalyzeBtn事件监听器
                        const pasteBtn = document.getElementById(elements.pasteAnalyzeBtn);
                        if (pasteBtn) {
                            pasteBtn.removeEventListener('click', pasteAnalyze);
                            pasteBtn.addEventListener('click', pasteAnalyze);
                        }
                        
                        // 检查并添加搜索框事件监听器
                        const tagSearch = document.getElementById(elements.tagSearchInput);
                        if (tagSearch) {
                            tagSearch.removeEventListener('input', debouncedTagSearch);
                            tagSearch.addEventListener('input', debouncedTagSearch);
                        }
                        
                        const presetSearch = document.getElementById(elements.presetSearchInput);
                        if (presetSearch) {
                            presetSearch.removeEventListener('input', debouncedPresetSearch);
                            presetSearch.addEventListener('input', debouncedPresetSearch);
                        }
                        
                        console.log('安全的事件监听器设置完成');
                    } catch (err) {
                        console.error('安全设置事件监听器时出错:', err);
                    }
                }
                
                // 尝试使用安全的事件监听器设置
                safeSetupEventListeners();
            }
            
            try {
                setupModalClickOutsideClose();
            } catch (error) {
                console.error('设置模态框关闭时出错:', error);
            }
            
            try {
                // 初始化评分星星和图片上传功能
                if (typeof setupRatingStarsHandlers === 'function') setupRatingStarsHandlers();
                if (typeof setupImageUploadHandlers === 'function') setupImageUploadHandlers();
                
                // 添加图片预览相关的样式
                if (typeof addImagePreviewStyles === 'function') addImagePreviewStyles();
            } catch (error) {
                console.error('初始化功能模块时出错:', error);
            }
            
            try {
                if (typeof renderTagTabButtons === 'function') renderTagTabButtons();
                if (typeof renderPresetTabButtons === 'function') renderPresetTabButtons();
                if (typeof renderGroupSidebar === 'function') renderGroupSidebar();
                if (typeof renderTags === 'function') renderTags();
                if (typeof renderPresets === 'function') renderPresets();
                if (typeof updateSelectedTagsDisplay === 'function') updateSelectedTagsDisplay();
                if (typeof updatePrompt === 'function') updatePrompt();
            } catch (error) {
                console.error('渲染界面时出错:', error);
            }
            
            try {
                if (typeof showNotification === 'function') {
                    showNotification('欢迎使用 Mayi Prompt UI 3.4.9', 'success');
                }
            } catch (error) {
                console.error('显示通知时出错:', error);
            }
            
            console.log('应用初始化完成');
        }

        function loadData() {
            console.log('正在加载数据...');

            // 加载主分类数据
            const savedMainCategories = localStorage.getItem('comfyui_v3_16_1015_main_categories');
            if (savedMainCategories) {
                settings.mainCategories = JSON.parse(savedMainCategories);
                // 强制将所有分类的isSystem设置为false
                settings.mainCategories.forEach(category => {
                    category.isSystem = false;
                });
                console.log('已加载主分类数据并强制设置isSystem=false:', settings.mainCategories);
            } else {
                settings.mainCategories = JSON.parse(JSON.stringify(defaultMainCategories));
                console.log('使用默认主分类数据');
            }

            // 加载标签数据
            const savedTags = localStorage.getItem('comfyui_v3_16_1015_tags');
            if (savedTags) {
                settings.tags = JSON.parse(savedTags);
                console.log('已加载标签数据');
            } else {
                settings.tags = JSON.parse(JSON.stringify(defaultTags));
                console.log('使用默认标签数据');
            }

            // 加载组内分组数据
            const savedGroups = localStorage.getItem('comfyui_v3_16_1015_groups');
            if (savedGroups) {
                settings.groups = JSON.parse(savedGroups);
                console.log('已加载组内分组数据');
            } else {
                settings.groups = JSON.parse(JSON.stringify(defaultGroups));
                console.log('使用默认组内分组数据');
            }

            // 加载Prompt分类数据
            const savedPresetCategories = localStorage.getItem('comfyui_v3_16_1015_preset_categories');
            if (savedPresetCategories) {
                settings.presetCategories = JSON.parse(savedPresetCategories);
                // 强制将所有Prompt分类的isSystem设置为false
                settings.presetCategories.forEach(category => {
                    category.isSystem = false;
                });
                console.log('已加载Prompt分类数据并强制设置isSystem=false:', settings.presetCategories);
            } else {
                settings.presetCategories = JSON.parse(JSON.stringify(defaultPresetCategories));
                console.log('使用默认Prompt分类数据');
            }

            // 加载Prompt数据
            const savedPresets = localStorage.getItem('comfyui_v3_16_1015_presets');
            if (savedPresets) {
                settings.presets = JSON.parse(savedPresets);
                // 为旧数据添加评分和收藏字段
                Object.keys(settings.presets).forEach(category => {
                    settings.presets[category].forEach(preset => {
                        if (preset.rating === undefined) preset.rating = 5;
                        if (preset.favorite === undefined) preset.favorite = false;
                    });
                });
                console.log('已加载Prompt数据');
            } else {
                settings.presets = JSON.parse(JSON.stringify(defaultPresets));
                console.log('使用默认Prompt数据');
            }

            // 加载其他设置
            const savedSettings = localStorage.getItem('comfyui_v3_16_1015_settings');
            if (savedSettings) {
                const saved = JSON.parse(savedSettings);
                settings.showPlusMinus = saved.showPlusMinus !== undefined ? saved.showPlusMinus : true;
                settings.weightSymbol = saved.weightSymbol || '()';
                settings.showDelete = saved.showDelete !== undefined ? saved.showDelete : true;
                settings.showR18Groups = saved.showR18Groups !== undefined ? saved.showR18Groups : false;
                settings.showNegative = saved.showNegative !== undefined ? saved.showNegative : false;
                settings.currentTab = saved.currentTab || 'favorites';
                settings.currentPresetTab = saved.currentPresetTab || 'anime';
                settings.selectedTags = saved.selectedTags || [];
                settings.favorites = saved.favorites || [];
                console.log('已加载其他设置');
            } else {
                console.log('使用默认设置');
            }

            console.log('数据加载完成');
        }

        // CSV 解析与同步通用方法
        function parseTagsFromCSV(csvText, categoryId) {
            try {
                const text = csvText.replace(/^\uFEFF/, '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                const rawLines = text.split('\n').filter(l => l.trim().length > 0);
                if (rawLines.length === 0) return { groups: [], tags: [] };

                const splitWith = (line, delim) => {
                    const result = [];
                    let cur = '';
                    let inQuotes = false;
                    for (let i = 0; i < line.length; i++) {
                        const ch = line[i];
                        if (ch === '"') {
                            if (inQuotes && line[i + 1] === '"') { cur += '"'; i++; }
                            else { inQuotes = !inQuotes; }
                        } else if (ch === delim && !inQuotes) {
                            result.push(cur.trim());
                            cur = '';
                        } else {
                            cur += ch;
                        }
                    }
                    result.push(cur.trim());
                    return result;
                };

                const delimiters = [',', '，', ';'];
                let headerFields = null;
                let delimiter = ',';
                for (let d of delimiters) {
                    const fields = splitWith(rawLines[0], d);
                    if (fields.length >= 3) { headerFields = fields; delimiter = d; break; }
                }
                if (!headerFields) {
                    console.warn('CSV 表头不匹配，无法解析分隔符');
                    return { groups: [], tags: [] };
                }

                const norm = headerFields.map(h => h.replace(/^"|"$/g, '').trim().toLowerCase());
                const idxGroup = norm.findIndex(h => ['分类','分组','group','category'].includes(h));
                const idxEn = norm.findIndex(h => ['英文标签','english','en','tag'].includes(h));
                const idxZh = norm.findIndex(h => ['中文翻译','中文','zh','name','translation'].includes(h));
                if (idxGroup === -1) console.warn('CSV 未提供“分类/分组”列');
                if (idxEn === -1) console.warn('CSV 未提供“英文标签”列');
                if (idxZh === -1) console.warn('CSV 未提供“中文翻译/名称”列');

                const groupsMap = new Map();
                const tags = [];
                for (let i = 1; i < rawLines.length; i++) {
                    const cols = splitWith(rawLines[i], delimiter);
                    if (Math.max(idxGroup, idxEn, idxZh) >= cols.length) {
                        const groupNameOnly = (idxGroup >= 0 && cols[idxGroup]) ? cols[idxGroup].replace(/^"|"$/g, '').trim() : '';
                        if (groupNameOnly) {
                            const gid = groupNameOnly;
                            if (!groupsMap.has(gid)) {
                                groupsMap.set(gid, { id: gid, name: groupNameOnly, description: groupNameOnly });
                            }
                        }
                        continue;
                    }

                    const groupName = (idxGroup >= 0 ? cols[idxGroup] : '').replace(/^"|"$/g, '').trim();
                    const english = (idxEn >= 0 ? cols[idxEn] : '').replace(/^"|"$/g, '').trim().replace(/^`|`$/g, '');
                    const chinese = (idxZh >= 0 ? cols[idxZh] : '').replace(/^"|"$/g, '').trim();

                    if (groupName) {
                        const gid = groupName;
                        if (!groupsMap.has(gid)) groupsMap.set(gid, { id: gid, name: groupName, description: groupName });
                    }
                    if (!english || !chinese) continue;

                    const gid = groupName || 'default';
                    const tagId = `${categoryId}_${english}`;
                    tags.push({
                        id: tagId,
                        name: chinese,
                        text: english,
                        color: '#2563eb',
                        group: gid,
                        allowPin: true,
                        allowFavorite: true
                    });
                }

                const seen = new Set();
                const uniqueTags = [];
                for (const t of tags) {
                    const key = `${t.text}|${t.group}`;
                    if (!seen.has(key)) { seen.add(key); uniqueTags.push(t); }
                }

                return { groups: Array.from(groupsMap.values()), tags: uniqueTags };
            } catch (err) {
                console.error('CSV 解析失败:', err);
                return { groups: [], tags: [] };
            }
        }

        async function syncTagsFromCSV(categoryId, fileName) {
            try {
                const resp = await fetch(fileName);
                if (!resp.ok) {
                    console.warn(`${fileName} 未找到，跳过 ${categoryId} 同步`);
                    return;
                }
                const csv = await resp.text();
                const { groups, tags } = parseTagsFromCSV(csv, categoryId);
                if (!settings.groups) settings.groups = {};
                if (!settings.tags) settings.tags = {};
                const finalGroups = (groups && groups.length) ? groups : [{ id: 'default', name: '默认分组', description: '默认分组' }];
                const finalTags = tags || [];
                // 严格覆盖：分组按 CSV 分类严格设置（即使没有标签行也创建分组）
                defaultGroups[categoryId] = finalGroups;
                defaultTags[categoryId] = finalTags;
                settings.groups[categoryId] = finalGroups;
                settings.tags[categoryId] = finalTags;

                // 如果当前选中的分组在新的分组集合中不存在，则自动回退到 "all"
                if (settings.currentTab === categoryId) {
                    const newGroupIds = new Set(finalGroups.map(g => g.id));
                    if (!newGroupIds.has(settings.currentGroup)) {
                        settings.currentGroup = 'all';
                    }
                }

                saveData();
                console.log(`已从 ${fileName} 同步 ${categoryId}，分组 ${finalGroups.length}，标签 ${finalTags.length}`);
                if (settings.currentTab === categoryId) {
                    if (typeof renderGroupSidebar === 'function') renderGroupSidebar();
                    if (typeof renderTags === 'function') renderTags();
                }
            } catch (e) {
                console.error(`同步 ${categoryId} 分类标签失败:`, e);
            }
        }

        function saveData() {
            console.log('正在保存数据...');
            try {
                localStorage.setItem('comfyui_v3_16_1015_main_categories', JSON.stringify(settings.mainCategories));
                localStorage.setItem('comfyui_v3_16_1015_tags', JSON.stringify(settings.tags));
                localStorage.setItem('comfyui_v3_16_1015_groups', JSON.stringify(settings.groups));
                localStorage.setItem('comfyui_v3_16_1015_preset_categories', JSON.stringify(settings.presetCategories));
                localStorage.setItem('comfyui_v3_16_1015_presets', JSON.stringify(settings.presets));
                localStorage.setItem('comfyui_v3_16_1015_settings', JSON.stringify({
                    showPlusMinus: settings.showPlusMinus,
                    weightSymbol: settings.weightSymbol,
                    showDelete: settings.showDelete,
                    showR18Groups: settings.showR18Groups,
                    showNegative: settings.showNegative,
                    currentTab: settings.currentTab,
                    currentPresetTab: settings.currentPresetTab,
                    selectedTags: settings.selectedTags,
                    favorites: settings.favorites
                }));
                console.log('数据保存成功');
            } catch (error) {
                console.error('数据保存失败:', error);
                showNotification('数据保存失败，可能是存储空间不足', 'error');
            }
        }

        function initializeEventListeners() {
            console.log('正在初始化事件监听器...');

            // 安全地添加事件监听器，避免空引用错误
            const safeAddEventListener = (elementId, event, callback) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.addEventListener(event, callback);
                    return true;
                }
                console.warn(`元素 ${elementId} 不存在，跳过事件监听器绑定`);
                return false;
            };

            // 编辑模式切换
            safeAddEventListener('editModeBtn', 'click', toggleEditMode);

            // 清空所有标签
            safeAddEventListener('clearAllBtn', 'click', clearAllTags);

            // 复制提示词
            safeAddEventListener('copyPrompt', 'click', copyPrompt);

            // 下载提示词
            safeAddEventListener('downloadPrompt', 'click', downloadPrompt);

            // 切换加减号显示
            safeAddEventListener('togglePlusMinus', 'click', togglePlusMinus);

            // 切换删除按钮显示
            safeAddEventListener('toggleDelete', 'click', toggleDelete);

            // 主分类管理
            safeAddEventListener('manageMainCategoriesBtn', 'click', openMainCategoryManagementModal);

            // Prompt分类管理
            safeAddEventListener('managePresetCategoriesBtn', 'click', openPresetCategoryManagementModal);

            // 新建Prompt
            safeAddEventListener('newPresetBtn', 'click', openNewPresetModal);

            // 数据管理
            safeAddEventListener('showDataManagementBtn', 'click', openDataManagementModal);

            // 模态框关闭按钮
            safeAddEventListener('cancelEditTagBtn', 'click', () => {
                const modal = document.getElementById('editTagModal');
                if (modal) modal.classList.remove('show');
            });

            safeAddEventListener('confirmEditTagBtn', 'click', confirmEditTag);

            safeAddEventListener('cancelNewTagBtn', 'click', () => {
                const modal = document.getElementById('newTagModal');
                if (modal) modal.classList.remove('show');
            });

            safeAddEventListener('confirmNewTagBtn', 'click', confirmNewTag);

            safeAddEventListener('cancelNewGroupBtn', 'click', () => {
                const modal = document.getElementById('newGroupModal');
                if (modal) modal.classList.remove('show');
            });

            safeAddEventListener('confirmNewGroupBtn', 'click', confirmNewGroup);

            safeAddEventListener('closeMainCategoryManagementBtn', 'click', () => {
                const modal = document.getElementById('mainCategoryManagementModal');
                if (modal) modal.classList.remove('show');
            });

            safeAddEventListener('addMainCategoryBtn', 'click', addMainCategory);

            safeAddEventListener('closePresetCategoryManagementBtn', 'click', () => {
                const modal = document.getElementById('presetCategoryManagementModal');
                if (modal) modal.classList.remove('show');
            });

            safeAddEventListener('addPresetCategoryBtn', 'click', addPresetCategory);

            safeAddEventListener('cancelNewPresetBtn', 'click', () => {
                const modal = document.getElementById('newPresetModal');
                if (modal) modal.classList.remove('show');
            });

            safeAddEventListener('confirmNewPresetBtn', 'click', confirmNewPreset);

            safeAddEventListener('cancelEditPresetBtn', 'click', () => {
                const modal = document.getElementById('editPresetModal');
                if (modal) modal.classList.remove('show');
            });

            safeAddEventListener('confirmEditPresetBtn', 'click', confirmEditPreset);

            safeAddEventListener('closeDataManagementBtn', 'click', () => {
                const modal = document.getElementById('dataManagementModal');
                if (modal) {
                    modal.classList.remove('show');
                    if (typeof hideImportOptions === 'function') hideImportOptions();
                }
            });

            safeAddEventListener('exportAllData', 'click', exportAllData);

            safeAddEventListener('importAllData', 'click', showImportOptions);

            safeAddEventListener('cancelImportBtn', 'click', hideImportOptions);

            safeAddEventListener('importFile', 'change', handleFileImport);

            safeAddEventListener('resetAllData', 'click', resetAllData);

            safeAddEventListener('showLocalStorageInfo', 'click', showLocalStorageInfo);

            safeAddEventListener('closeLocalStorageInfoBtn', 'click', () => {
                const modal = document.getElementById('localStorageInfoModal');
                if (modal) modal.classList.remove('show');
            });

            // 标签管理标题三击切换 R18 分组显示/隐藏
            let tagHeaderClickCount = 0;
            let tagHeaderClickResetTimer = null;
            const handleTagManagementTripleClick = () => {
                tagHeaderClickCount++;
                if (tagHeaderClickResetTimer) clearTimeout(tagHeaderClickResetTimer);
                tagHeaderClickResetTimer = setTimeout(() => { tagHeaderClickCount = 0; }, 800);
                if (tagHeaderClickCount >= 3) {
                    tagHeaderClickCount = 0;
                    settings.showR18Groups = !settings.showR18Groups;
                    if (typeof saveData === 'function') saveData();
                    // 先重渲染标签页按钮，保证R18页即时显隐
                    if (typeof renderTagTabButtons === 'function') renderTagTabButtons();
                    // 再刷新分组侧栏和标签内容
                    if (typeof renderGroupSidebar === 'function') renderGroupSidebar();
                    if (typeof renderTags === 'function') renderTags();
                    if (typeof showNotification === 'function') {
                        showNotification(settings.showR18Groups ? '已显示 R18 分组' : '已隐藏 R18 分组', 'info');
                    }
                }
            };
            safeAddEventListener('tagManagementHeader', 'click', handleTagManagementTripleClick);

            // 评分星星事件 - 安全处理
            const setupRatingStars = (containerId, ratingInputId) => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.querySelectorAll('.star').forEach(star => {
                        star.addEventListener('click', function() {
                            const rating = parseInt(this.dataset.rating);
                            const input = document.getElementById(ratingInputId);
                            if (input && typeof updateRatingStars === 'function') {
                                input.value = rating;
                                updateRatingStars(containerId, rating);
                            }
                        });
                    });
                }
            };

            setupRatingStars('newPresetRatingStars', 'newPresetRating');
            setupRatingStars('editPresetRatingStars', 'editPresetRating');

            // 修复问题1：添加解析粘贴按钮的事件监听器
            const pasteAnalyzeBtn = document.getElementById('pasteAnalyzeBtn');
            if (pasteAnalyzeBtn) {
                pasteAnalyzeBtn.addEventListener('click', pasteAnalyze);
            }

            // 解析新建标签模态框事件
            document.getElementById('cancelParseTagBtn').addEventListener('click', () => {
                document.getElementById('parseNewTagModal').classList.remove('show');
            });

            document.getElementById('confirmParseTagBtn').addEventListener('click', confirmParseTag);

            // 防抖函数
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // 标签搜索功能（带防抖）
            const tagSearchInput = document.getElementById('tagSearchInput');
            if (tagSearchInput) {
                const debouncedTagSearch = debounce(function() {
                    currentTagSearch = this.value.trim().toLowerCase();
                    console.log('标签搜索关键词:', currentTagSearch);
                    renderTags(); // 重新渲染标签
                }, 300); // 300ms防抖延迟
                
                tagSearchInput.addEventListener('input', debouncedTagSearch);
            }

            // Prompt搜索功能（带防抖）
            const presetSearchInput = document.getElementById('presetSearchInput');
            if (presetSearchInput) {
                const debouncedPresetSearch = debounce(function() {
                    currentPresetSearch = this.value.trim().toLowerCase();
                    console.log('Prompt搜索关键词:', currentPresetSearch);
                    renderPresets(); // 重新渲染Prompt
                }, 300); // 300ms防抖延迟
                
                presetSearchInput.addEventListener('input', debouncedPresetSearch);
            }

            console.log('事件监听器初始化完成');
            
            // 设置默认分组
            if (!settings.currentGroup) {
                settings.currentGroup = 'all'; // 默认显示所有分组
            }
            // 启用搜索与提示词候选增强
            setupTagSearchSuggestions();
            setupPresetSearchSuggestions();
            setupPromptSuggestions();
        }

        function setupModalClickOutsideClose() {
            // 点击模态框外部关闭模态框
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('show');
                        hideImportOptions();
                    }
                });
            });
        }
        
        function switchTagTab(categoryId) {
            settings.currentTab = categoryId;
            settings.currentGroup = 'all'; // 切换分类时重置分组选择
            renderTagTabButtons();
            renderGroupSidebar();
            renderTags();
            saveData();
        }
        
        // 切换分组
        function switchGroup(groupId) {
            settings.currentGroup = groupId;
            renderGroupSidebar();
            renderTags();
            saveData();
        }
        
        // 渲染左侧分组列表
        // 更新标签排序顺序并保存
        function updateTagsSortOrder(category, container) {
            const categoryTags = settings.tags[category] || [];
            const tagsInContainer = Array.from(container.querySelectorAll('.tag-item'));
            
            // 简单的排序索引更新
            tagsInContainer.forEach((tagElement, index) => {
                const tagId = tagElement.dataset.tagId;
                const tag = categoryTags.find(t => t.id === tagId);
                if (tag) {
                    tag.sortIndex = index;
                }
            });
            
            // 保存更新后的排序
            saveData();
            showNotification('标签排序已更新', 'success');
        }
        
        function renderGroupSidebar() {
            var container = document.getElementById('groupList');
            if (!container) return;
            
            container.innerHTML = '';
            
            var category = settings.currentTab;
            var groups = settings.groups[category] || [{ id: 'default', name: '默认分组', description: '默认分组' }];
            
            // 添加"全部"选项
            var allItem = document.createElement('div');
            var allItemClass = 'group-item p-2 rounded-lg cursor-pointer transition-all ';
            if (settings.currentGroup === 'all') {
                allItemClass += 'bg-primary text-white';
            } else {
                allItemClass += 'hover:bg-gray-200';
            }
            allItem.className = allItemClass;
            allItem.textContent = '全部标签';
            allItem.dataset.groupId = 'all';
            allItem.onclick = function() {
                switchGroup('all');
            };
            container.appendChild(allItem);
            
            // 添加"收藏"选项（显示当前分类下的收藏标签）
            var favoritesItem = document.createElement('div');
            var favoritesItemClass = 'group-item p-2 rounded-lg cursor-pointer transition-all ';
            if (settings.currentGroup === 'favorites') {
                favoritesItemClass += 'bg-primary text-white';
            } else {
                favoritesItemClass += 'hover:bg-gray-200';
            }
            favoritesItem.className = favoritesItemClass;
            
            // 计算当前分类下的收藏标签数量
            var category = settings.currentTab;
            var categoryFavoritesCount = 0;
            if (settings.favorites) {
                categoryFavoritesCount = settings.favorites.filter(fav => {
                    // 检查收藏的标签是否属于当前分类
                    var tagInfo = getTagInfoById(fav);
                    return tagInfo && tagInfo.category === category;
                }).length;
            }
            
            favoritesItem.innerHTML = '<div class="flex items-center justify-between">' +
                '<span><i class="fas fa-heart text-red-500 mr-1"></i> 收藏</span>' +
                '<span class="text-xs bg-gray-200 px-2 py-0.5 rounded-full">' + categoryFavoritesCount + '</span>' +
                '</div>';
            favoritesItem.dataset.groupId = 'favorites';
            favoritesItem.onclick = function() {
                switchGroup('favorites');
            };
            container.appendChild(favoritesItem);
            
            // R18分组显示控制
            var filteredGroups = groups;
            if (!settings.showR18Groups && category === 'r18') {
                var tempGroups = [];
                for (var g = 0; g < groups.length; g++) {
                    if (groups[g].name.toLowerCase() !== 'r18') {
                        tempGroups.push(groups[g]);
                    }
                }
                filteredGroups = tempGroups;
            }
            
            // 添加各个分组
            for (var i = 0; i < filteredGroups.length; i++) {
                var group = filteredGroups[i];
                var tags = settings.tags[category] || [];
                var groupTagCount = 0;
                for (var j = 0; j < tags.length; j++) {
                    if (tags[j].group === group.id) {
                        groupTagCount++;
                    }
                }
                
                var item = document.createElement('div');
                var itemClass = 'group-item p-2 rounded-lg transition-all ';
                if (settings.currentGroup === group.id) {
                    itemClass += 'bg-primary text-white';
                } else {
                    itemClass += 'hover:bg-gray-200';
                }
                item.className = itemClass;
                item.dataset.groupId = group.id;
                
                // 移除分组列表中的编辑功能，统一在h4标签处编辑
                if (settings.tagEditingMode) {
                    item.className = itemClass + 'cursor-pointer';
                }
                
                // 构建分组项内容
                var descriptionHtml = '';
                if (group.description) {
                    descriptionHtml = '<div class="text-xs text-gray-400 mt-1">' + group.description + '</div>';
                }
                item.innerHTML = '<div class="flex items-center justify-between">' +
                    '<span>' + group.name + '</span>' +
                    '<span class="text-xs bg-gray-200 px-2 py-0.5 rounded-full">' + groupTagCount + '</span>' +
                    '</div>' + descriptionHtml;
                
                item.onclick = function() {
                    switchGroup(this.dataset.groupId);
                };
                
                container.appendChild(item);
            }
        }
        
        // 移动端分组列表切换按钮事件 - 安全处理
        const toggleGroupList = document.getElementById('toggleGroupList');
        if (toggleGroupList) {
            toggleGroupList.addEventListener('click', function() {
                const tagSidebar = document.getElementById('tagSidebar');
                if (tagSidebar) {
                    const isHidden = tagSidebar.classList.contains('hidden');
                    
                    if (isHidden) {
                        tagSidebar.classList.remove('hidden');
                        const span = this.querySelector('span');
                        if (span) span.textContent = '隐藏分组列表';
                    } else {
                        tagSidebar.classList.add('hidden');
                        const span = this.querySelector('span');
                        if (span) span.textContent = '显示分组列表';
                    }
                }
            });
        } else {
            console.warn('toggleGroupList元素不存在');
        }

        function switchPresetTab(categoryId) {
            settings.currentPresetTab = categoryId;
            renderPresetTabButtons();
            renderPresets();
            saveData();
        }

        function renderTagTabButtons() {
            console.log('正在渲染标签页按钮...');
            const container = document.getElementById('tagTabContainer');
            if (!container) {
                console.error('标签页容器不存在');
                return;
            }

            container.innerHTML = '';

            if (!settings.mainCategories || settings.mainCategories.length === 0) {
                console.error('主分类数据为空');
                return;
            }

            // 过滤掉favorites分类，只渲染普通一级分类
            settings.mainCategories.filter(category => category.id !== 'favorites').forEach(category => {
                // 当R18分类隐藏时，跳过渲染R18标签页
                if (category.id === 'r18' && !settings.showR18Groups) {
                    // 若当前tab为R18，切换到'style'避免空状态
                    if (settings.currentTab === 'r18') settings.currentTab = 'style';
                    return;
                }
                let tagCount = settings.tags[category.id] ? settings.tags[category.id].length : 0;
                
                const button = document.createElement('button');
                const isR18 = category.id === 'r18';
                button.className = `tab-button ${settings.currentTab === category.id ? 'active' : ''} ${isR18 ? 'r18-tab' : ''}`;
                button.dataset.category = category.id;
                button.innerHTML = `${category.name} <span class="badge">${tagCount}</span>`;

                button.addEventListener('click', function() {
                    switchTagTab(category.id);
                });

                container.appendChild(button);
            });

            console.log('标签页按钮渲染完成');
        }

        function renderPresetTabButtons() {
            console.log('正在渲染Prompt标签页按钮...');
            const container = document.getElementById('presetTabContainer');
            if (!container) {
                console.error('Prompt标签页容器不存在');
                return;
            }

            container.innerHTML = '';

            if (!settings.presetCategories || settings.presetCategories.length === 0) {
                console.error('Prompt分类数据为空');
                return;
            }

            settings.presetCategories.forEach(category => {
                const presetCount = settings.presets[category.id] ? settings.presets[category.id].length : 0;
                const button = document.createElement('button');
                button.className = `tab-button ${settings.currentPresetTab === category.id ? 'active' : ''}`;
                button.dataset.category = category.id;
                button.innerHTML = `${category.name} <span class="badge">${presetCount}</span>`;

                button.addEventListener('click', function() {
                    switchPresetTab(category.id);
                });

                container.appendChild(button);
            });

            console.log('Prompt标签页按钮渲染完成');
        }
        
        // 搜索候选与跳转、高亮 & 提示词同步
        function setupTagSearchSuggestions() {
            const input = document.getElementById('tagSearchInput');
            if (!input) return;
            const onInput = debounce(function() {
                const q = this.value.trim().toLowerCase();
                currentTagSearch = q;
                renderTags();
                if (!q) { hideSuggestionDropdown(input); return; }
                const items = findTagsByKeyword(q).slice(0, 8);
                showSuggestionDropdown(input, items, function(item) {
                    hideSuggestionDropdown(input);
                    input.value = '';
                    currentTagSearch = '';
                    jumpToTag(item.category, item.groupId, item.id);
                });
            }, 200);
            input.addEventListener('input', onInput);
            input.addEventListener('blur', () => setTimeout(() => hideSuggestionDropdown(input), 150));
        }
        
        function setupPresetSearchSuggestions() {
            const input = document.getElementById('presetSearchInput');
            if (!input) return;
            const onInput = debounce(function() {
                const q = this.value.trim().toLowerCase();
                currentPresetSearch = q;
                renderPresets();
                if (!q) { hideSuggestionDropdown(input); return; }
                const items = findPresetsByKeyword(q).slice(0, 8);
                showSuggestionDropdown(input, items, function(item) {
                    hideSuggestionDropdown(input);
                    input.value = '';
                    currentPresetSearch = '';
                    jumpToPreset(item.category, item.id);
                });
            }, 200);
            input.addEventListener('input', onInput);
            input.addEventListener('blur', () => setTimeout(() => hideSuggestionDropdown(input), 150));
        }
        
        function setupPromptSuggestions() {
            const textarea = document.getElementById('positivePrompt');
            if (!textarea) return;
            
            const onInput = debounce(function() {
                // 同步标签联动
                syncSelectedTagsFromPrompt();
                
                // 仅在输入片段存在时展示候选（逗号分隔的最后一段）
                const caret = textarea.selectionStart || 0;
                const before = (textarea.value || '').slice(0, caret);
                const fragment = before.split(',').pop().trim().toLowerCase();
                if (!fragment) { hideSuggestionDropdown(textarea); return; }
                const items = findTagsByKeyword(fragment).slice(0, 8);
                
                // 显示候选，点击后用候选替换当前输入片段，并自动添加英文逗号
                showSuggestionDropdown(textarea, items, function(item) {
                    hideSuggestionDropdown(textarea);
                    const start = textarea.selectionStart || 0;
                    const end = textarea.selectionEnd || start;
                    const value = textarea.value;
                    const before = value.slice(0, start);
                    const after = value.slice(end);
                    // 找到最后一个逗号，定位本次输入片段的起始位置
                    const lastComma = before.lastIndexOf(',');
                    let tokenStart = lastComma >= 0 ? lastComma + 1 : 0;
                    // 跳过片段起始处的空白
                    while (tokenStart < before.length && /\s/.test(before[tokenStart])) tokenStart++;
                    let newBefore = value.slice(0, tokenStart).replace(/\s+$/, '');
                    // 保证逗号后只有一个空格；如果不是以逗号结尾且有内容，则补充", "
                    if (newBefore) {
                        if (/,$/.test(newBefore)) {
                            if (!/\s$/.test(newBefore)) newBefore += ' ';
                        } else {
                            newBefore += ', ';
                        }
                    }
                    const insertionText = item.text || item.label || '';
                    // 如果后续不以逗号开始，则在插入后补充", "，保证分隔
                    const needCommaAfter = after.length === 0 || !/^\s*,/.test(after);
                    const suffix = needCommaAfter ? ', ' : '';
                    textarea.value = newBefore + insertionText + suffix + after;
                    const evt = new Event('input', { bubbles: true });
                    textarea.dispatchEvent(evt);
                });
            }, 220);
            
            textarea.addEventListener('input', onInput);
            textarea.addEventListener('blur', () => setTimeout(() => hideSuggestionDropdown(textarea), 150));
        }
        
        function jumpToTag(categoryId, groupId, tagId) {
            switchTagTab(categoryId);
            if (groupId) switchGroup(groupId);
            setTimeout(() => scrollToTagAfterRender(tagId), 50);
        }
        
        function scrollToTagAfterRender(tagId) {
            let tries = 0;
            const maxTries = 20;
            const tryFind = () => {
                const el = document.querySelector('#tagsContent [data-tag-id="' + tagId + '"]');
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    el.classList.add('ring-4');
                    el.classList.add('ring-blue-400');
                    setTimeout(() => { el.classList.remove('ring-4'); el.classList.remove('ring-blue-400'); }, 1500);
                    return;
                }
                if (++tries < maxTries) setTimeout(tryFind, 100);
            };
            tryFind();
        }
        
        function jumpToPreset(categoryId, presetId) {
            switchPresetTab(categoryId);
            setTimeout(() => scrollToPresetAfterRender(presetId), 50);
        }
        
        function scrollToPresetAfterRender(presetId) {
            let tries = 0;
            const maxTries = 20;
            const tryFind = () => {
                const el = document.querySelector('#presetContent .preset-item[data-preset-id="' + presetId + '"]');
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    el.style.outline = '3px solid #3B82F6';
                    setTimeout(() => { el.style.outline = ''; }, 1500);
                    return;
                }
                if (++tries < maxTries) setTimeout(tryFind, 100);
            };
            tryFind();
        }
        
        function parseTokenWeight(raw) {
            let text = raw.trim();
            let weight = 1.0;
            const parenMatch = text.match(/^\((.+?):([0-9]+(?:\.[0-9]+)?)\)$/);
            if (parenMatch) {
                text = parenMatch[1].trim();
                weight = parseFloat(parenMatch[2]);
                return { text, weight };
            }
            const colonMatch = text.match(/^(.*?):\s*([0-9]+(?:\.[0-9]+)?)$/);
            if (colonMatch) {
                text = colonMatch[1].trim();
                weight = parseFloat(colonMatch[2]);
            }
            return { text, weight };
        }
        
        function findTagByText(text) {
            const target = (text || '').trim().toLowerCase();
            if (!target) return null;
            for (const categoryId in settings.tags) {
                const tags = settings.tags[categoryId] || [];
                for (const tag of tags) {
                    if ((tag.text || '').toLowerCase() === target) {
                        return { ...tag, category: categoryId };
                    }
                }
            }
            return null;
        }
        
        function findTagsByKeyword(keyword) {
            const q = (keyword || '').trim().toLowerCase();
            const items = [];
            (settings.mainCategories || []).forEach(cat => {
                const categoryId = cat.id;
                const categoryName = cat.name;
                const tags = settings.tags[categoryId] || [];
                const groups = settings.groups[categoryId] || [];
                tags.forEach(tag => {
                    if ((tag.name || '').toLowerCase().includes(q) || (tag.text || '').toLowerCase().includes(q)) {
                        const group = groups.find(g => g.id === tag.group);
                        items.push({
                            type: 'tag', id: tag.id, text: tag.text, name: tag.name,
                            category: categoryId, categoryName,
                            groupId: tag.group, groupName: group ? group.name : '未分组',
                            label: tag.text,
                            secondary: `${categoryName} · ${group ? group.name : '未分组'}`
                        });
                    }
                });
            });
            return items;
        }
        
        function findPresetsByKeyword(keyword) {
            const q = (keyword || '').trim().toLowerCase();
            const items = [];
            (settings.presetCategories || []).forEach(cat => {
                const categoryId = cat.id;
                const categoryName = cat.name;
                const presets = settings.presets[categoryId] || [];
                presets.forEach(preset => {
                    const nameMatch = (preset.name || '').toLowerCase().includes(q);
                    const descMatch = (preset.description || '').toLowerCase().includes(q);
                    const promptMatch = (preset.prompt || '').toLowerCase().includes(q);
                    if (nameMatch || descMatch || promptMatch) {
                        items.push({
                            type: 'preset', id: preset.id, name: preset.name,
                            category: categoryId, categoryName,
                            label: preset.name,
                            secondary: `${categoryName}`
                        });
                    }
                });
            });
            return items;
        }
        
        function syncSelectedTagsFromPrompt() {
            const textarea = document.getElementById('positivePrompt');
            if (!textarea) return;
            const raw = textarea.value || '';
            const tokens = raw.split(',').map(t => t.trim()).filter(Boolean);
            const nextSelected = [];
            tokens.forEach(tok => {
                const { text, weight } = parseTokenWeight(tok);
                const found = findTagByText(text);
                const safeWeight = Math.max(0.1, Math.min(2.0, weight || 1.0));
                if (found) {
                    nextSelected.push({ id: found.id, name: found.name, text: found.text, weight: safeWeight });
                } else {
                    nextSelected.push({ id: 'custom:' + text.toLowerCase(), name: text, text: text, weight: safeWeight });
                }
            });
            settings.selectedTags = nextSelected;
            saveData();
            updateSelectedTagsDisplay();
            renderTags();
        }
        
        function showSuggestionDropdown(anchorInput, items, onSelect) {
            const parent = anchorInput.offsetParent || anchorInput.parentElement || anchorInput;
            const id = anchorInput.id + '-suggestions';
            let dropdown = parent.querySelector('#' + id);
            if (!dropdown) {
                dropdown = document.createElement('div');
                dropdown.id = id;
                dropdown.className = 'suggestion-dropdown';
                parent.appendChild(dropdown);
            }
            // 确保定位参照父容器，避免覆盖到输入框内部
            if (getComputedStyle(parent).position === 'static') {
                parent.style.position = 'relative';
            }
            dropdown.innerHTML = '';
            if (!items || items.length === 0) {
                dropdown.innerHTML = '<div class="suggestion-empty">无匹配项</div>';
                return;
            }
            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'suggestion-item';
                el.innerHTML = `<span class="suggestion-primary">${escapeHtml(item.label || '')}</span><span class="suggestion-secondary">${escapeHtml(item.secondary || '')}</span>`;
                el.addEventListener('mousedown', function(e) { e.preventDefault(); onSelect(item); });
                dropdown.appendChild(el);
            });
            // 让下拉严格对齐到输入框下方且宽度与输入框一致
            dropdown.style.left = anchorInput.offsetLeft + 'px';
            dropdown.style.top = (anchorInput.offsetTop + anchorInput.offsetHeight) + 'px';
            dropdown.style.width = anchorInput.offsetWidth + 'px';
            dropdown.style.right = '';
        }
        
        function hideSuggestionDropdown(anchorInput) {
            const parent = anchorInput.offsetParent || anchorInput.parentElement || anchorInput;
            const id = anchorInput.id + '-suggestions';
            const dropdown = parent.querySelector('#' + id);
            if (dropdown) dropdown.remove();
        }

        // 渲染当前分类下的收藏标签的函数
        function renderCategoryFavoriteTags(content, category) {
            // 获取收藏标签列表
            const favorites = settings.favorites || [];
            
            // 过滤出当前分类下的收藏标签
            const categoryFavorites = favorites
                .map(favId => getTagInfoById(favId))
                .filter(tag => tag && tag.category === category);
            
            // 应用搜索过滤
            let filteredTags = categoryFavorites;
            if (currentTagSearch) {
                const searchLower = currentTagSearch.toLowerCase();
                filteredTags = filteredTags.filter(tag => 
                    tag.name.toLowerCase().includes(searchLower) || 
                    tag.text.toLowerCase().includes(searchLower)
                );
            }
            
            // 置顶标签在前
            filteredTags.sort((a, b) => a.pinned ? -1 : b.pinned ? 1 : 0);
            
            let html = `
                <div class="mb-4">
                    <div class="bg-gradient-to-r from-gray-100 to-gray-200 p-3 rounded-lg mb-2">
                        <div class="group-header">
                            <h4 class="group-title">
                                <i class="fas fa-heart text-red-500 mr-2"></i>
                                收藏标签
                            </h4>
                            <div class="group-info">
                                <span class="group-count">${filteredTags.length}个标签</span>
                            </div>
                        </div>
                    </div>
                    <div class="pl-4 border-l-2 border-gray-300">
                        <div class="tags-container">
            `;
            
            // 渲染每个收藏标签
            if (filteredTags.length > 0) {
                html += filteredTags.map(tag => `
                    <div class="tag-item ${isTagSelected(tag.id) ? 'ring-2 ring-yellow-400' : ''} ${tag.pinned ? 'ring-2 ring-red-500' : ''} ${tag.favorite ? 'ring-2 ring-orange-500' : ''}"
                         style="background: linear-gradient(135deg, ${tag.color} 0%, ${lightenColor(tag.color, 20)} 100%);"
                         data-tag-id="${tag.id}"
                         data-category="${category}">
                        <div class="tag-content">
                            <div class="tag-text">${tag.text}</div>
                            <div class="tag-name">${tag.name}</div>
                        </div>
                        
                        <!-- 操作按钮 -->
                        <div class="tag-actions">
                            ${!settings.tagEditingMode ? (
                                `
                                ${tag.allowPin ? `
                                    <button class="btn pin-btn ${!tag.allowPin ? 'disabled' : ''}" 
                                            data-tag-id="${tag.id}" 
                                            title="${tag.pinned ? '取消置顶' : '置顶'}"
                                            ${!tag.allowPin ? 'disabled' : ''}>
                                                <i class="fas fa-thumbtack ${tag.pinned ? '' : 'fa-rotate-90'}"></i>
                                    </button>
                                ` : ''}
                                ${tag.allowFavorite ? `
                                    <button class="btn favorite-btn ${!tag.allowFavorite ? 'disabled' : ''}" 
                                            data-tag-id="${tag.id}" 
                                            title="取消收藏" 
                                            ${!tag.allowFavorite ? 'disabled' : ''}>
                                                <i class="fas fa-star"></i>
                                    </button>
                                ` : ''}
                                `
                            ) : (
                                `
                                <button class="btn edit-tag-btn" data-tag-id="${tag.id}" data-category="${category}" title="编辑">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn delete-tag-btn" data-tag-id="${tag.id}" data-category="${category}" title="删除">
                                    <i class="fas fa-times"></i>
                                </button>
                                `
                            )}
                        </div>
                    </div>
                `).join('');
            } else {
                html += `
                    <div class="text-gray-500 text-center py-4">
                        ${currentTagSearch ? '没有匹配的收藏标签' : '暂无收藏标签'}
                    </div>
                `;
            }
            
            html += `
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            
            // 隐藏加载指示器
            const loadingIndicator = document.getElementById('tagsLoadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.classList.remove('show');
            }
            
            // 绑定标签点击事件
            bindTagEvents();
        }
        
        function renderTags() {
            console.log('正在渲染标签...');
            const content = document.getElementById('tagsContent');
            if (!content) {
                console.error('标签内容容器不存在');
                return;
            }
            
            // 显示加载指示器
            const loadingIndicator = document.getElementById('tagsLoadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.classList.add('show');
            }
            
            // 使用setTimeout确保UI更新
            setTimeout(() => {
                const category = settings.currentTab;
                
                // 确保currentGroup已初始化
                if (!settings.currentGroup) {
                    settings.currentGroup = 'all';
                }
                
                // 检查是否需要渲染收藏标签分组
                if (settings.currentGroup === 'favorites') {
                    renderCategoryFavoriteTags(content, category);
                    // 隐藏加载指示器
                    if (loadingIndicator) {
                        loadingIndicator.classList.remove('show');
                    }
                    return;
                }
                
                // 全局联动搜索：当存在搜索关键词时进行跨分类渲染
                if (currentTagSearch) {
                    renderGlobalSearchTags(content);
                    if (loadingIndicator) {
                        loadingIndicator.classList.remove('show');
                    }
                    return;
                }
                
                // 继续执行原有的标签渲染逻辑
                const tags = settings.tags[category] || [];
                const groups = settings.groups[category] || [{ id: 'default', name: '默认分组', description: '默认分组' }];

                // R18分组显示控制
                let filteredGroups = groups;
                if (!settings.showR18Groups && category === 'r18') {
                    filteredGroups = groups.filter(group => group.name.toLowerCase() !== 'r18');
                }

                // 按分组组织标签
                const tagsByGroup = {};
                filteredGroups.forEach(group => {
                    let groupTags = tags.filter(tag => tag.group === group.id);
                    
                    // 应用搜索过滤
                    if (currentTagSearch) {
                        const searchLower = currentTagSearch.toLowerCase();
                        groupTags = groupTags.filter(tag => 
                            tag.name.toLowerCase().includes(searchLower) || 
                            tag.text.toLowerCase().includes(searchLower)
                        );
                    }
                    
                    // 增强排序逻辑：首先按收藏状态，然后按置顶状态，最后按排序索引
                    groupTags.sort((a, b) => {
                        // 1. 收藏优先
                        const aFavorite = settings.favorites.includes(a.id);
                        const bFavorite = settings.favorites.includes(b.id);
                        if (aFavorite !== bFavorite) {
                            return aFavorite ? -1 : 1;
                        }
                        // 2. 置顶优先
                        if (a.pinned !== b.pinned) {
                            return a.pinned ? -1 : 1;
                        }
                        // 3. 按排序索引（如果存在）
                        return (a.sortIndex || 0) - (b.sortIndex || 0);
                    });
                    
                    tagsByGroup[group.id] = groupTags;
                });
                
                let html = '';
                let hasVisibleGroups = false;
                
                // 处理单个分组显示
                if (settings.currentGroup !== 'all' && settings.currentGroup !== 'favorites') {
                    const group = filteredGroups.find(g => g.id === settings.currentGroup);
                    if (group) {
                        const groupTags = tagsByGroup[group.id] || [];
                        const pinnedCount = groupTags.filter(tag => tag.pinned).length;
                        
                        html += `
                            <div class="mb-4">
                                <div class="bg-gradient-to-r from-gray-100 to-gray-200 p-3 rounded-lg mb-2">
                                    <div class="group-header">
                                        <h4 class="group-title" data-group-id="${group.id}" ${settings.tagEditingMode ? 'contenteditable="true"' : ''}>${group.name}</h4>
                                    </div>
                                </div>
                                <div class="pl-4 border-l-2 border-gray-300">
                                    <div class="tags-container">
                                        <!-- 新增标签按钮 -->
                                        <button class="group-add-button"
                                                data-category="${category}" data-group="${group.id}">
                                            <i class="fas fa-plus"></i>
                                            新增标签
                                        </button>
                                        
                                        ${groupTags.map(tag => `
                                            <div class="tag-item ${isTagSelected(tag.id) ? 'ring-2 ring-yellow-400' : ''} ${tag.pinned ? 'ring-2 ring-red-500' : ''} ${isTagFavorite(tag.id) ? 'ring-2 ring-orange-500' : ''}" 
                                                 style="background: linear-gradient(135deg, ${tag.color} 0%, ${lightenColor(tag.color, 20)} 100%);"
                                                 data-tag-id="${tag.id}" 
                                                 data-category="${category}">
                                                <span class="mr-2 cursor-move" onclick="event.stopPropagation();">
                                                    <i class="fas fa-grip-vertical"></i>
                                                </span>
                                                <div class="tag-content">
                                                    <div class="tag-text">${tag.text}</div>
                                                    <div class="tag-name">${tag.name}</div>
                                                </div>
                                                
                                                <!-- 操作按钮 -->
                                                <div class="tag-actions">
                                                    ${!settings.tagEditingMode ? (
                                                        `
                                                        ${tag.allowPin ? `
                                                            <button class="btn pin-btn ${!tag.allowPin ? 'disabled' : ''}" 
                                                                    data-tag-id="${tag.id}" 
                                                                    title="${tag.pinned ? '取消置顶' : '置顶'}"
                                                                    ${!tag.allowPin ? 'disabled' : ''}>
                                                                        <i class="fas fa-thumbtack ${tag.pinned ? '' : 'fa-rotate-90'}"></i>
                                                            </button>
                                                        ` : ''}
                                                        ${tag.allowFavorite ? `
                                                            <button class="btn favorite-btn ${!tag.allowFavorite ? 'disabled' : ''}" 
                                                                    data-tag-id="${tag.id}" 
                                                                    title="${isTagFavorite(tag.id) ? '取消收藏' : '收藏'}"
                                                                    ${!tag.allowFavorite ? 'disabled' : ''}>
                                                                        <i class="fas fa-star ${isTagFavorite(tag.id) ? '' : 'fa-regular'}"></i>
                                                            </button>
                                                        ` : ''}
                                                        `
                                                    ) : (
                                                        `
                                                        <button class="btn edit-tag-btn" data-tag-id="${tag.id}" data-category="${category}" title="编辑">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn delete-tag-btn" data-tag-id="${tag.id}" data-category="${category}" title="删除">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                        `
                                                    )}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    content.innerHTML = html;
                } else {
                    // 显示所有分组
                    filteredGroups.forEach(group => {
                        const groupTags = tagsByGroup[group.id] || [];
                        const pinnedCount = groupTags.filter(tag => tag.pinned).length;

                        // 如果搜索时分组没有匹配的标签，则跳过该分组
                        if (currentTagSearch && groupTags.length === 0) {
                            return;
                        }
                        
                        // 如果有搜索关键词且没有匹配的分组，标记为有可见分组
                        if (currentTagSearch && groupTags.length > 0) {
                            hasVisibleGroups = true;
                        }
                        
                        // 如果没有搜索，标记为有可见分组
                        if (!currentTagSearch) {
                            hasVisibleGroups = true;
                        }

                        html += `
                            <div class="mb-4">
                                <div class="bg-gradient-to-r from-gray-100 to-gray-200 p-3 rounded-lg mb-2">
                                    <div class="group-header">
                                        <h4 class="group-title" data-group-id="${group.id}" ${settings.tagEditingMode ? 'contenteditable="true"' : ''}>${group.name}</h4>
                                        <div class="group-info">
                                            ${pinnedCount > 0 ? `<span class="group-count">(${pinnedCount}个置顶)</span>` : ''}
                                            <span class="group-count">${groupTags.length}个标签</span>
                                            ${settings.tagEditingMode ? `
                                                <button class="btn btn-sm add-group-btn" 
                                                        data-category="${category}" 
                                                        data-group="${group.id}"
                                                        title="新建子分组">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="pl-4 border-l-2 border-gray-300">
                                    <div class="tags-container">
                                        <!-- 修复问题3：新增标签按钮在默认模式下也显示 -->
                                        <button class="group-add-button"
                                                data-category="${category}" data-group="${group.id}">
                                            <i class="fas fa-plus"></i>
                                            新增标签
                                        </button>

                                        ${groupTags.map(tag => `
                                            <div class="tag-item ${isTagSelected(tag.id) ? 'ring-2 ring-yellow-400' : ''} ${tag.pinned ? 'ring-2 ring-red-500' : ''} ${isTagFavorite(tag.id) ? 'ring-2 ring-orange-500' : ''}" 
                                                 style="background: linear-gradient(135deg, ${tag.color} 0%, ${lightenColor(tag.color, 20)} 100%);"
                                                 data-tag-id="${tag.id}" 
                                                 data-category="${category}">
                                                <span class="mr-2 cursor-move" onclick="event.stopPropagation();">
                                                    <i class="fas fa-grip-vertical"></i>
                                                </span>
                                                <div class="tag-text">${tag.text}</div>
                                                <div class="tag-name">${tag.name}</div>
                                                
                                                <!-- 操作按钮 -->
                                                <div class="tag-actions">
                                                    ${!settings.tagEditingMode ? (
                                                        `
                                                        ${tag.allowPin ? `
                                                            <button class="btn pin-btn ${!tag.allowPin ? 'disabled' : ''}" 
                                                                    data-tag-id="${tag.id}" 
                                                                    title="${tag.pinned ? '取消置顶' : '置顶'}"
                                                                    ${!tag.allowPin ? 'disabled' : ''}>
                                                                        <i class="fas fa-thumbtack ${tag.pinned ? '' : 'fa-rotate-90'}"></i>
                                                            </button>
                                                        ` : ''}
                                                        ${tag.allowFavorite ? `
                                                            <button class="btn favorite-btn ${!tag.allowFavorite ? 'disabled' : ''}" 
                                                                    data-tag-id="${tag.id}" 
                                                                    title="${isTagFavorite(tag.id) ? '取消收藏' : '收藏'}"
                                                                    ${!tag.allowFavorite ? 'disabled' : ''}>
                                                                        <i class="fas fa-star ${isTagFavorite(tag.id) ? '' : 'fa-regular'}"></i>
                                                            </button>
                                                        ` : ''}
                                                        `
                                                    ) : (
                                                        `
                                                        <button class="btn edit-tag-btn" data-tag-id="${tag.id}" data-category="${category}" title="编辑">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn delete-tag-btn" data-tag-id="${tag.id}" data-category="${category}" title="删除">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                        `
                                                    )}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    // 如果搜索结果为空，显示提示信息
                    if (currentTagSearch && !hasVisibleGroups) {
                        content.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-search"></i>
                                <p>未找到匹配的标签</p>
                                <small>请尝试使用其他关键词搜索</small>
                            </div>
                        `;
                    } else {
                        content.innerHTML = html;
                    }
                }
                
                attachTagEvents();
                
                // 隐藏加载指示器
                if (loadingIndicator) {
                    loadingIndicator.classList.remove('show');
                }
                
                console.log('标签渲染完成');
            }, 0);
        }

        function renderFavoriteTags(content) {
            console.log('正在渲染收藏标签...');
            const favoriteTags = [];

            // 遍历所有分类查找收藏标签
            Object.keys(settings.tags).forEach(categoryId => {
                const categoryTags = settings.tags[categoryId] || [];
                categoryTags.forEach(tag => {
                    if (settings.favorites.includes(tag.id)) {
                        favoriteTags.push({
                            ...tag,
                            category: categoryId
                        });
                    }
                });
            });

            if (favoriteTags.length === 0) {
                content.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-heart"></i>
                        <p>暂无收藏标签</p>
                        <small>点击标签上的星星图标添加到收藏</small>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="tags-container">
                    ${favoriteTags.map(tag => `
                        <div class="tag-item ${isTagSelected(tag.id) ? 'ring-2 ring-yellow-400' : ''} ${tag.pinned ? 'ring-2 ring-red-500' : ''} ring-2 ring-orange-500" 
                             style="background: linear-gradient(135deg, ${tag.color} 0%, ${lightenColor(tag.color, 20)} 100%);"
                             data-tag-id="${tag.id}" 
                             data-category="${tag.category}">
                            <span class="mr-2 cursor-move" onclick="event.stopPropagation();">
                                <i class="fas fa-grip-vertical"></i>
                            </span>
                            <div class="tag-content">
                                <div class="tag-text">${tag.text}</div>
                                <div class="tag-name">${tag.name}</div>
                            </div>
                            
                            <!-- 操作按钮 -->
                            <div class="tag-actions">
                                ${!settings.tagEditingMode ? (
                                    `
                                    ${tag.allowPin ? `
                                        <button class="btn pin-btn ${!tag.allowPin ? 'disabled' : ''}" 
                                                data-tag-id="${tag.id}" 
                                                title="${tag.pinned ? '取消置顶' : '置顶'}"
                                                ${!tag.allowPin ? 'disabled' : ''}>
                                                    <i class="fas fa-thumbtack ${tag.pinned ? '' : 'fa-rotate-90'}"></i>
                                        </button>
                                    ` : ''}
                                    <button class="btn favorite-btn" data-tag-id="${tag.id}" title="取消收藏">
                                        <i class="fas fa-star"></i>
                                    </button>
                                    `
                                ) : (
                                    `
                                    <button class="btn edit-tag-btn" data-tag-id="${tag.id}" data-category="${tag.category}" title="编辑">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn delete-tag-btn" data-tag-id="${tag.id}" data-category="${tag.category}" title="删除">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    `
                                )}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            content.innerHTML = html;
            
            attachTagEvents();
            console.log('收藏标签渲染完成');
        }

        function renderGlobalSearchTags(content) {
            console.log('正在渲染全局搜索结果...');
            const searchLower = (currentTagSearch || '').trim().toLowerCase();
            if (!searchLower) {
                // 如果没有关键字，回退到正常渲染
                renderTags();
                return;
            }

            let html = '';
            let hasVisible = false;

            (settings.mainCategories || []).forEach(cat => {
                const categoryId = cat.id;
                const categoryName = cat.name;
                const tags = settings.tags[categoryId] || [];
                const groups = settings.groups[categoryId] || [{ id: 'default', name: '默认分组', description: '默认分组' }];

                let categoryHtmlSections = '';

                groups.forEach(group => {
                    let groupTags = tags.filter(tag => tag.group === group.id && (
                        (tag.name || '').toLowerCase().includes(searchLower) ||
                        (tag.text || '').toLowerCase().includes(searchLower)
                    ));

                    // 与常规渲染一致的排序逻辑
                    groupTags.sort((a, b) => {
                        const aFavorite = settings.favorites.includes(a.id);
                        const bFavorite = settings.favorites.includes(b.id);
                        if (aFavorite !== bFavorite) return aFavorite ? -1 : 1;
                        if (a.pinned !== b.pinned) return a.pinned ? -1 : 1;
                        return (a.sortIndex || 0) - (b.sortIndex || 0);
                    });

                    if (groupTags.length > 0) {
                        hasVisible = true;
                        const pinnedCount = groupTags.filter(tag => tag.pinned).length;
                        categoryHtmlSections += `
                            <div class="mb-4">
                                <div class="bg-gradient-to-r from-gray-100 to-gray-200 p-3 rounded-lg mb-2">
                                    <div class="group-header">
                                        <h4 class="group-title" data-group-id="${group.id}">${group.name}</h4>
                                        <div class="group-info">
                                            ${pinnedCount > 0 ? `<span class="group-count">(${pinnedCount}个置顶)</span>` : ''}
                                            <span class="group-count">${groupTags.length}个标签</span>
                                            ${settings.tagEditingMode ? `
                                                <button class="btn btn-sm add-group-btn" 
                                                        data-category="${categoryId}" 
                                                        data-group="${group.id}"
                                                        title="新建子分组">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="pl-4 border-l-2 border-gray-300">
                                    <div class="tags-container">
                                        <button class="group-add-button" data-category="${categoryId}" data-group="${group.id}">
                                            <i class="fas fa-plus"></i>
                                            新增标签
                                        </button>
                                        ${groupTags.map(tag => `
                                            <div class="tag-item ${isTagSelected(tag.id) ? 'ring-2 ring-yellow-400' : ''} ${tag.pinned ? 'ring-2 ring-red-500' : ''} ${isTagFavorite(tag.id) ? 'ring-2 ring-orange-500' : ''}" 
                                                 style="background: linear-gradient(135deg, ${tag.color} 0%, ${lightenColor(tag.color, 20)} 100%);"
                                                 data-tag-id="${tag.id}" 
                                                 data-category="${categoryId}">
                                                <span class="mr-2 cursor-move" onclick="event.stopPropagation();">
                                                    <i class="fas fa-grip-vertical"></i>
                                                </span>
                                                <div class="tag-content">
                                                    <div class="tag-text">${tag.text}</div>
                                                    <div class="tag-name">${tag.name}</div>
                                                </div>
                                                <div class="tag-actions">
                                                    ${!settings.tagEditingMode ? (
                                                        `
                                                        ${tag.allowPin ? `
                                                            <button class="btn pin-btn ${!tag.allowPin ? 'disabled' : ''}" 
                                                                    data-tag-id="${tag.id}" 
                                                                    title="${tag.pinned ? '取消置顶' : '置顶'}"
                                                                    ${!tag.allowPin ? 'disabled' : ''}>
                                                                        <i class="fas fa-thumbtack ${tag.pinned ? '' : 'fa-rotate-90'}"></i>
                                                            </button>
                                                        ` : ''}
                                                        ${tag.allowFavorite ? `
                                                            <button class="btn favorite-btn ${!tag.allowFavorite ? 'disabled' : ''}" 
                                                                    data-tag-id="${tag.id}" 
                                                                    title="${isTagFavorite(tag.id) ? '取消收藏' : '收藏'}"
                                                                    ${!tag.allowFavorite ? 'disabled' : ''}>
                                                                        <i class="fas fa-star ${isTagFavorite(tag.id) ? '' : 'fa-regular'}"></i>
                                                            </button>
                                                        ` : ''}
                                                        `
                                                    ) : (
                                                        `
                                                        <button class="btn edit-tag-btn" data-tag-id="${tag.id}" data-category="${categoryId}" title="编辑">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn delete-tag-btn" data-tag-id="${tag.id}" data-category="${categoryId}" title="删除">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                        `
                                                    )}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });

                if (categoryHtmlSections) {
                    html += `
                        <div class="mb-6">
                            <div class="bg-gradient-to-r from-sky-100 to-sky-200 p-3 rounded-lg mb-2">
                                <div class="group-header">
                                    <h3 class="group-title">${categoryName}</h3>
                                </div>
                            </div>
                            ${categoryHtmlSections}
                        </div>
                    `;
                }
            });

            if (!hasVisible) {
                content.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>未找到跨分类的匹配标签</p>
                        <small>请调整关键词或创建新标签</small>
                    </div>
                `;
                return;
            }

            content.innerHTML = html;
            attachTagEvents();
            console.log('全局搜索标签渲染完成');
        }

        function attachTagEvents() {
            console.log('正在附加标签事件...');

            // 标签点击事件
            document.querySelectorAll('.tag-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.target.closest('.tag-actions')) return;
                    const tagId = this.dataset.tagId;
                    const category = this.dataset.category;
                    toggleTagSelection(tagId, category);
                });
            });
            
            // 简单的拖动排序实现 - 使用原生的拖放API
            document.querySelectorAll('.tags-container').forEach(container => {
                let draggedItem = null;
                
                // 为每个标签容器设置拖放功能
                let items = container.querySelectorAll('.tag-item');
                items.forEach(item => {
                    // 启用拖动
                    item.setAttribute('draggable', 'true');
                    
                    // 拖动开始
                    item.addEventListener('dragstart', function(e) {
                        draggedItem = this;
                        // 设置拖动时的半透明效果
                        setTimeout(() => {
                            this.style.opacity = '0.5';
                        }, 0);
                    });
                    
                    // 拖动结束
                    item.addEventListener('dragend', function() {
                        draggedItem = null;
                        // 重置样式
                        items.forEach(i => {
                            i.style.opacity = '1';
                            i.style.border = 'none';
                        });
                    });
                    
                    // 拖动经过
                    item.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        // 显示插入位置提示
                        this.style.borderTop = '2px solid white';
                    });
                    
                    // 拖动离开
                    item.addEventListener('dragleave', function() {
                        this.style.borderTop = 'none';
                    });
                    
                    // 放置
                    item.addEventListener('drop', function(e) {
                        e.preventDefault();
                        this.style.borderTop = 'none';
                        
                        if (draggedItem && draggedItem !== this) {
                            const container = this.closest('.tags-container');
                            const category = settings.currentTab;
                            
                            // 获取拖动和放置元素的位置
                            const draggedRect = draggedItem.getBoundingClientRect();
                            const dropRect = this.getBoundingClientRect();
                            const draggedIndex = Array.from(items).indexOf(draggedItem);
                            const dropIndex = Array.from(items).indexOf(this);
                            
                            // 根据位置决定插入顺序
                            if (draggedIndex < dropIndex) {
                                container.insertBefore(draggedItem, this.nextSibling);
                            } else {
                                container.insertBefore(draggedItem, this);
                            }
                            
                            // 更新排序索引
                            updateTagsSortOrder(category, container);
                        }
                    });
                });
            });

            // 编辑标签按钮
            document.querySelectorAll('.edit-tag-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const tagId = this.dataset.tagId;
                    const category = this.dataset.category;
                    openEditTagModal(tagId, category);
                });
            });

            // 修复问题2：确保删除标签按钮事件正确绑定
            document.querySelectorAll('.delete-tag-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const tagId = this.dataset.tagId;
                    const category = this.dataset.category;
                    deleteTag(tagId, category);
                });
            });

            // 置顶标签按钮
            document.querySelectorAll('.pin-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const tagId = this.dataset.tagId;
                    const category = (this.closest('.tag-item') && this.closest('.tag-item').dataset.category) || settings.currentTab;
                    toggleTagPin(tagId, category);
                });
            });

            // 收藏标签按钮
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const tagId = this.dataset.tagId;
                    toggleTagFavorite(tagId);
                });
            });

            // 组内新增标签按钮
            document.querySelectorAll('.group-add-button').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const category = this.dataset.category;
                    const group = this.dataset.group;
                    openNewTagModal(category, group);
                });
            });

            // 新建子分组按钮 - 修复：编辑模式下可以新建组内分组
            document.querySelectorAll('.add-group-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const category = this.dataset.category;
                    const group = this.dataset.group;
                    openAddGroupModal(category, group);
                });
            });

            // 为可编辑的分组名称添加事件监听器
            document.querySelectorAll('.group-title[contenteditable="true"]').forEach(h4 => {
                let originalName = h4.textContent.trim();
                
                // 失去焦点时保存
                h4.addEventListener('blur', function() {
                    saveGroupName(this);
                });
                
                // 按Enter键保存，按Escape键取消
                h4.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // 阻止默认的换行行为
                        this.blur(); // 触发blur事件进行保存
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        this.textContent = originalName;
                        this.blur();
                    }
                });
                
                // 开始编辑时记录原始值
                h4.addEventListener('focus', function() {
                    originalName = this.textContent.trim();
                });
            });

            console.log('标签事件附加完成');
        }
        
        // 保存分组名称的函数
        function saveGroupName(element) {
            const groupId = element.dataset.groupId;
            const category = settings.currentTab;
            const newName = element.textContent.trim();
            const groups = settings.groups[category] || [];
            
            if (newName && groups.length > 0) {
                const group = groups.find(g => g.id === groupId);
                if (group && newName !== group.name) {
                    group.name = newName;
                    saveData();
                    renderGroupSidebar(); // 同步更新分组列表
                } else if (!newName) {
                    // 如果名称为空，恢复原来的名称
                    element.textContent = group ? group.name : '';
                }
            }
        }

        function renderPresets() {
            console.log('正在渲染Preset...');
            const content = document.getElementById('presetContent');
            if (!content) {
                console.error('Preset内容容器不存在');
                return;
            }
            
            // 显示加载指示器
            const loadingIndicator = document.getElementById('presetLoadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.classList.add('show');
            }
            
            // 使用setTimeout确保UI更新
            setTimeout(() => {
                // 函数内容继续...
                const category = settings.currentPresetTab;
                const presets = settings.presets[category] || [];

                if (presets.length === 0) {
                    content.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-lightbulb"></i>
                            <p>该分类下暂无Preset</p>
                            <small>点击"新建Prompt"按钮创建</small>
                        </div>
                    `;
                    // 隐藏加载指示器
                    if (loadingIndicator) {
                        loadingIndicator.classList.remove('show');
                    }
                    return;
                }

                // 搜索过滤
                let filteredPresets = presets;
                if (currentPresetSearch) {
                    filteredPresets = presets.filter(preset => 
                        (preset.name && preset.name.toLowerCase().includes(currentPresetSearch)) || 
                        (preset.description && preset.description.toLowerCase().includes(currentPresetSearch)) ||
                        (preset.prompt && preset.prompt.toLowerCase().includes(currentPresetSearch))
                    );
                }

                if (filteredPresets.length === 0) {
                    content.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <p>未找到匹配的Prompt</p>
                            <small>请尝试使用其他关键词搜索</small>
                        </div>
                    `;
                    // 隐藏加载指示器
                    if (loadingIndicator) {
                        loadingIndicator.classList.remove('show');
                    }
                    return;
                }

                let html = '';
                filteredPresets.forEach(preset => {
                    const ratingStars = '★'.repeat(preset.rating) + '☆'.repeat(10 - preset.rating);
                    html += `
                        <div class="preset-item bg-gradient-to-br from-white to-gray-50 p-4 rounded-xl border border-gray-200 hover:shadow-lg transition-shadow">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold text-lg">${preset.name}</h4>
                                <div class="flex gap-1">
                                    ${!settings.presetEditingMode ? `
                                        <button class="btn btn-sm btn-primary apply-preset-btn" data-preset-id="${preset.id}" data-category="${category}">
                                            <i class="fas fa-paper-plane"></i> 应用
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-info edit-preset-btn" data-preset-id="${preset.id}" data-category="${category}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-preset-btn" data-preset-id="${preset.id}" data-category="${category}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <p class="text-gray-600 text-sm mb-3">${preset.description}</p>
                            ${preset.image ? `
                                <div class="mb-3">
                                    <img src="${preset.image}" alt="${preset.name}" class="w-full max-h-48 object-contain object-center rounded-lg">
                                </div>
                            ` : ''}
                            <div class="mb-3">
                                <div class="bg-gray-800 text-green-400 p-3 rounded-lg font-mono text-sm overflow-x-auto">
                                    ${preset.prompt}
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="rating">
                                    ${ratingStars}
                                </div>
                                <div class="text-xs text-gray-500">
                                    ${new Date(preset.createdAt).toLocaleDateString('zh-CN')}
                                </div>
                            </div>
                        </div>
                    `;
                });

                content.innerHTML = html;
                
                // 绑定事件
                document.querySelectorAll('.apply-preset-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const presetId = this.dataset.presetId;
                        const category = this.dataset.category;
                        applyPreset(presetId, category);
                    });
                });
                
                // 为提示词区域添加点击复制功能
                document.querySelectorAll('.preset-item .bg-gray-800').forEach(promptArea => {
                    promptArea.addEventListener('click', function() {
                        const promptText = this.textContent.trim();
                        if (promptText) {
                            navigator.clipboard.writeText(promptText).then(() => {
                                showNotification('提示词已复制到剪贴板', 'success');
                            }).catch(err => {
                                console.error('复制失败:', err);
                                // 降级方案
                                const textArea = document.createElement('textarea');
                                textArea.value = promptText;
                                document.body.appendChild(textArea);
                                textArea.select();
                                document.execCommand('copy');
                                document.body.removeChild(textArea);
                                showNotification('提示词已复制到剪贴板', 'success');
                            });
                        }
                    });
                    // 添加光标样式以指示可点击
                    promptArea.style.cursor = 'pointer';
                    promptArea.title = '点击复制提示词';
                });

                document.querySelectorAll('.edit-preset-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const presetId = this.dataset.presetId;
                        const category = this.dataset.category;
                        openEditPresetModal(presetId, category);
                    });
                });

                document.querySelectorAll('.delete-preset-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const presetId = this.dataset.presetId;
                        const category = this.dataset.category;
                        deletePreset(presetId, category);
                    });
                });
                
                // 隐藏加载指示器
                if (loadingIndicator) {
                    loadingIndicator.classList.remove('show');
                }
                
                console.log('Preset渲染完成');
            }, 0);
        }

        function toggleEditMode() {
            settings.tagEditingMode = !settings.tagEditingMode;
            const editBtn = document.getElementById('editModeBtn');
            if (editBtn) {
                editBtn.innerHTML = settings.tagEditingMode ? 
                    '<i class="fas fa-times"></i> 退出编辑' : 
                    '<i class="fas fa-edit"></i> 编辑模式';
                editBtn.className = settings.tagEditingMode ? 'btn btn-danger' : 'btn btn-primary';
            }
            renderTags();
            renderGroupSidebar(); // 添加这一行确保分组列表也被重新渲染
            showNotification(settings.tagEditingMode ? '已进入编辑模式' : '已退出编辑模式', 'info');
        }

        function toggleTagSelection(tagId, category) {
            console.log('切换标签选择:', tagId, category);
            if (settings.tagEditingMode) return;

            const tag = findTagById(tagId, category);
            if (!tag) {
                console.error('标签不存在:', tagId, category);
                return;
            }

            const existingIndex = settings.selectedTags.findIndex(t => t.id === tagId);
            if (existingIndex > -1) {
                settings.selectedTags.splice(existingIndex, 1);
            } else {
                settings.selectedTags.push({
                    id: tagId,
                    name: tag.name,
                    text: tag.text,
                    weight: 1.0
                });
            }

            saveData();
            renderTags();
            updateSelectedTagsDisplay();
            updatePrompt();
        }

        function isTagSelected(tagId) {
            return settings.selectedTags.some(tag => tag.id === tagId);
        }

        function toggleTagPin(tagId, category) {
            console.log('切换标签置顶:', tagId, category);
            const tag = findTagById(tagId, category);
            if (tag) {
                tag.pinned = !tag.pinned;
                saveData();
                renderTags();
                showNotification(tag.pinned ? '标签已置顶' : '标签已取消置顶', 'success');
            }
        }

        function toggleTagFavorite(tagId) {
            console.log('切换标签收藏:', tagId);
            const index = settings.favorites.indexOf(tagId);
            if (index > -1) {
                settings.favorites.splice(index, 1);
                showNotification('标签已取消收藏', 'success');
            } else {
                settings.favorites.push(tagId);
                showNotification('标签已收藏', 'success');
            }
            saveData();
            renderTags();
        }

        function isTagFavorite(tagId) {
            return settings.favorites.includes(tagId);
        }

        function getTagInfoById(tagId) {
            // 搜索所有分类查找标签
            for (const categoryId in settings.tags) {
                const categoryTags = settings.tags[categoryId];
                const tag = categoryTags.find(t => t.id === tagId);
                if (tag) {
                    return {
                        ...tag,
                        category: categoryId
                    };
                }
            }
            return null;
        }

        function findTagById(tagId, category) {
            if (!category || !settings.tags[category]) {
                // 如果没有指定分类，搜索所有分类
                for (const catId in settings.tags) {
                    const tag = settings.tags[catId].find(t => t.id === tagId);
                    if (tag) return tag;
                }
                return null;
            }
            return settings.tags[category].find(tag => tag.id === tagId) || null;
        }

        function getCategoryName(categoryId) {
            const category = settings.mainCategories.find(cat => cat.id === categoryId);
            return category ? category.name : '未知分类';
        }

        function updateSelectedTagsDisplay() {
            console.log('更新已选择标签显示');
            const container = document.getElementById('selectedTags');
            if (!container) return;

            if (settings.selectedTags.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center w-full self-center py-3">点击下方标签添加到这里...</p>';
                return;
            }

            let html = '';
            settings.selectedTags.forEach((tag, index) => {
                html += `
                    <div class="selected-tag-item" data-index="${index}">
                        <div class="selected-tag-content">
                            <span class="selected-tag-text">${tag.text}</span>
                            <span class="selected-tag-name">${tag.name}</span>
                        </div>
                        <div class="selected-tag-actions">
                            ${settings.showPlusMinus ? `
                                <button class="btn btn-primary selected-tag-btn"
                                        data-index="${index}"
                                        data-action="decrease"
                                        title="减少权重">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button class="btn btn-primary selected-tag-btn"
                                        data-index="${index}"
                                        data-action="increase"
                                        title="增加权重">
                                    <i class="fas fa-plus"></i>
                                </button>
                            ` : ''}
                            ${settings.showDelete ? `
                                <button class="btn btn-danger selected-tag-btn"
                                        data-index="${index}"
                                        title="删除">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // 绑定已选择标签的操作事件
            document.querySelectorAll('.selected-tag-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    const action = this.dataset.action;

                    if (action === 'increase') {
                        if (settings.selectedTags[index].weight < 2.0) {
                            settings.selectedTags[index].weight += 0.1;
                            settings.selectedTags[index].weight = Math.round(settings.selectedTags[index].weight * 10) / 10;
                            saveData();
                            updateSelectedTagsDisplay();
                            updatePrompt();
                        }
                    } else if (action === 'decrease') {
                        if (settings.selectedTags[index].weight > 0.1) {
                            settings.selectedTags[index].weight -= 0.1;
                            settings.selectedTags[index].weight = Math.round(settings.selectedTags[index].weight * 10) / 10;
                            saveData();
                            updateSelectedTagsDisplay();
                            updatePrompt();
                        }
                    } else {
                        // 删除
                        settings.selectedTags.splice(index, 1);
                        saveData();
                        updateSelectedTagsDisplay();
                        updatePrompt();
                    }
                });
            });
        }

        function updatePrompt() {
            console.log('更新Prompt');
            let prompt = '';
            settings.selectedTags.forEach(tag => {
                if (prompt) prompt += ', ';
                if (settings.showPlusMinus && tag.weight !== 1.0) {
                    if (settings.weightSymbol === '()') {
                        prompt += `(${tag.text}:${tag.weight.toFixed(1)})`;
                    } else {
                        prompt += `${tag.text}:${tag.weight.toFixed(1)}`;
                    }
                } else {
                    prompt += tag.text;
                }
            });

            const promptElement = document.getElementById('positivePrompt');
            if (promptElement) {
                promptElement.value = prompt;
            }
        }

        function clearAllTags() {
            settings.selectedTags = [];
            saveData();
            renderTags();
            updateSelectedTagsDisplay();
            updatePrompt();
            showNotification('已清空所有已选择的标签', 'success');
        }

        function copyPrompt() {
            const promptElement = document.getElementById('positivePrompt');
            if (promptElement) {
                promptElement.select();
                document.execCommand('copy');
                showNotification('提示词已复制到剪贴板', 'success');
            }
        }

        function downloadPrompt() {
            const promptElement = document.getElementById('positivePrompt');
            if (promptElement) {
                const prompt = promptElement.value;
                const blob = new Blob([prompt], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'prompt.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('提示词已下载', 'success');
            }
        }

        function togglePlusMinus() {
            settings.showPlusMinus = !settings.showPlusMinus;
            saveData();
            updateSelectedTagsDisplay();
            updatePrompt();
            showNotification(settings.showPlusMinus ? '已显示权重调节按钮' : '已隐藏权重调节按钮', 'success');
        }

        function toggleDelete() {
            settings.showDelete = !settings.showDelete;
            saveData();
            updateSelectedTagsDisplay();
            showNotification(settings.showDelete ? '已显示删除按钮' : '已隐藏删除按钮', 'success');
        }

        function showNotification(message, type = 'info') {
            console.log('显示通知:', message, type);
            const notification = document.getElementById('notification');
            if (!notification) return;

            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
            `;

            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function lightenColor(color, percent) {
            const num = parseInt(color.replace("#", ""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;

            return "#" + (
                0x1000000 +
                (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)
            ).toString(16).slice(1);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateRatingStars(containerId, rating) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.querySelectorAll('.star').forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        // 图片上传处理函数
        function setupImageUploadHandlers() {
            // 为新建预设的图片上传设置事件处理
            const newImagePreview = document.getElementById('newPresetImagePreview');
            const newImageInput = document.getElementById('newPresetImage');
            const newImageData = document.getElementById('newPresetImageData');
            
            if (newImagePreview && newImageInput) {
                newImagePreview.addEventListener('click', () => newImageInput.click());
                newImageInput.addEventListener('change', (e) => handleImageUpload(e, newImagePreview, newImageData));
                setupDragDrop(newImagePreview, newImageInput, newImageData);
            }
            
            // 为编辑预设的图片上传设置事件处理
            const editImagePreview = document.getElementById('editPresetImagePreview');
            const editImageInput = document.getElementById('editPresetImage');
            const editImageData = document.getElementById('editPresetImageData');
            
            if (editImagePreview && editImageInput) {
                editImagePreview.addEventListener('click', () => editImageInput.click());
                editImageInput.addEventListener('change', (e) => handleImageUpload(e, editImagePreview, editImageData));
                setupDragDrop(editImagePreview, editImageInput, editImageData);
            }
        }

        function handleImageUpload(event, previewElement, dataInput) {
            const file = event.target.files[0];
            if (!file) return;
            
            // 检查文件类型
            if (!file.type.startsWith('image/')) {
                showNotification('请上传图片文件', 'error');
                return;
            }
            
            // 检查文件大小 (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('图片文件不能超过5MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                previewElement.innerHTML = `<img src="${e.target.result}" alt="预览图片">`;
                dataInput.value = e.target.result;
                showNotification('图片上传成功', 'success');
            };
            reader.readAsDataURL(file);
        }

        function setupDragDrop(previewElement, inputElement, dataInput) {
            previewElement.addEventListener('dragover', (e) => {
                e.preventDefault();
                previewElement.classList.add('dragover');
            });
            
            previewElement.addEventListener('dragleave', () => {
                previewElement.classList.remove('dragover');
            });
            
            previewElement.addEventListener('drop', (e) => {
                e.preventDefault();
                previewElement.classList.remove('dragover');
                
                if (e.dataTransfer.files.length) {
                    const file = e.dataTransfer.files[0];
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    inputElement.files = dataTransfer.files;
                    
                    // 触发change事件
                    const event = new Event('change', { bubbles: true });
                    inputElement.dispatchEvent(event);
                }
            });
        }

        // 为评分星星绑定点击事件
        function setupRatingStarsHandlers() {
            // 新建预设的评分星星
            document.querySelectorAll('#newPresetRatingStars .star').forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    document.getElementById('newPresetRating').value = rating;
                    updateRatingStars('newPresetRatingStars', rating);
                });
            });
            
            // 编辑预设的评分星星
            document.querySelectorAll('#editPresetRatingStars .star').forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    document.getElementById('editPresetRating').value = rating;
                    updateRatingStars('editPresetRatingStars', rating);
                });
            });
        }
        
        // 添加重置图片预览函数
        function resetImagePreview(previewId) {
            const preview = document.getElementById(previewId);
            if (preview) {
                preview.innerHTML = '<i class="fas fa-image"></i><span>点击上传图片或拖拽到此处</span>';
            }
        }
        
        // 添加图片预览相关的样式
        function addImagePreviewStyles() {
            const style = document.createElement('style');
            style.textContent = `
                /* 图片上传预览样式 */
                .image-upload-container {
                    position: relative;
                }
                
                .image-preview {
                    width: 100%;
                    height: clamp(150px, 30vh, 320px);
                    min-height: 120px;
                    max-height: 320px;
                    border: 2px dashed #ccc;
                    border-radius: 4px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    background-color: #f9f9f9;
                    transition: all 0.3s ease;
                    overflow: hidden;
                }
                
                @media (max-width: 768px) {
                    .image-preview {
                        height: clamp(140px, 25vh, 240px);
                        max-height: 240px;
                    }
                }
                
                @media (max-width: 480px) {
                    .image-preview {
                        height: clamp(120px, 22vh, 200px);
                        max-height: 200px;
                    }
                }
                
                .image-preview:hover {
                    border-color: #4CAF50;
                    background-color: #f0f0f0;
                }
                
                .image-preview i {
                    font-size: 32px;
                    color: #999;
                    margin-bottom: 8px;
                }
                
                .image-preview span {
                    color: #666;
                    text-align: center;
                }
                
                .image-preview img {
                    width: auto;
                    height: auto;
                    max-width: 100%;
                    max-height: 100%;
                    object-fit: contain;
                    object-position: center;
                    border-radius: 2px;
                }
                
                /* 预设卡片图片样式 */
                .preset-image {
                    width: 100%;
                    height: auto;
                    margin-bottom: 10px;
                    border-radius: 4px;
                    background-color: #f8f9fa;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 5px;
                }
                
                .preset-image img {
                    width: 100%;
                    height: auto;
                    max-height: 200px;
                    object-fit: contain;
                    border-radius: 2px;
                }
                
                .preset-card:hover .preset-image img {
                    transform: scale(1.05);
                }
                
                /* 评分星星样式增强 */
                .rating-stars .star {
                    cursor: pointer;
                    color: #ccc;
                    transition: color 0.2s ease;
                }
                
                .rating-stars .star.active {
                    color: #ffc107;
                }
                
                .rating-stars .star:hover {
                    color: #ffc107;
                }
                
                .rating-stars .star:hover ~ .star {
                    color: #ccc;
                }
            `;
            document.head.appendChild(style);
        }

        // 修复问题2：确保删除标签函数正常工作
        function deleteTag(tagId, category) {
            if (confirm('确定要删除这个标签吗？')) {
                const tag = findTagById(tagId, category);
                if (tag) {
                    // 从标签数组中删除
                    const tags = settings.tags[category] || [];
                    const index = tags.findIndex(t => t.id === tagId);
                    if (index !== -1) {
                        tags.splice(index, 1);
                    }

                    // 从已选择标签中删除
                    settings.selectedTags = settings.selectedTags.filter(t => t.id !== tagId);

                    // 从收藏中删除
                    settings.favorites = settings.favorites.filter(id => id !== tagId);

                    saveData();
                    renderTags();
                    updateSelectedTagsDisplay();
                    updatePrompt();
                    
                    showNotification('标签已删除', 'success');
                }
            }
        }

        // 修复问题1：添加解析粘贴功能
        function pasteAnalyze() {
            const promptElement = document.getElementById('positivePrompt');
            const parsedContainer = document.getElementById('parsedTagsContainer');
            
            if (!promptElement || !parsedContainer) {
                showNotification('解析粘贴功能需要的元素不存在', 'error');
                return;
            }

            const prompt = promptElement.value.trim();
            if (!prompt) {
                showNotification('请先在文本框中粘贴提示词', 'warning');
                return;
            }

            try {
                // 显示解析中状态
                parsedContainer.style.display = 'block';
                parsedContainer.innerHTML = '<div class="text-center py-4"><div class="loading"></div> 正在解析提示词...</div>';

                // 简单的标签解析逻辑
                setTimeout(() => {
                    const tags = parsePromptTags(prompt);
                    displayParsedTags(tags);
                }, 500);
            } catch (error) {
                console.error('解析提示词失败:', error);
                parsedContainer.innerHTML = '<div class="text-red-500 text-center py-4">解析失败: ' + error.message + '</div>';
            }
        }

        function parsePromptTags(prompt) {
            // 简单的标签解析逻辑
            // 这里可以根据实际需要扩展更复杂的解析规则
            const tags = [];
            
            // 只按英文逗号分割
            const parts = prompt.split(/,/).filter(part => part.trim() !== '');
            
            parts.forEach(part => {
                const tagText = part.trim();
                if (tagText) {
                    // 检查是否为已存在的标签
                    let existingTag = null;
                    let category = null;
                    
                    // 搜索所有分类中的标签
                    for (const catId in settings.tags) {
                        const tag = settings.tags[catId].find(t => 
                            t.text.toLowerCase() === tagText.toLowerCase() ||
                            t.name.toLowerCase() === tagText.toLowerCase()
                        );
                        if (tag) {
                            existingTag = tag;
                            category = catId;
                            break;
                        }
                    }
                    
                    tags.push({
                        text: tagText,
                        isExisting: !!existingTag,
                        existingTag: existingTag,
                        category: category
                    });
                }
            });
            
            return tags;
        }

        function displayParsedTags(tags) {
            const parsedContainer = document.getElementById('parsedTagsContainer');
            if (!parsedContainer) return;

            if (tags.length === 0) {
                parsedContainer.innerHTML = '<div class="text-gray-500 text-center py-4">未解析到任何标签</div>';
                return;
            }

            let html = `
                <div class="mb-2">
                    <span class="text-sm font-semibold text-gray-700">解析结果:</span>
                    <span class="text-xs text-gray-500 ml-2">
                        <span class="inline-block w-3 h-3 bg-blue-200 border border-blue-400 rounded-full mr-1"></span>
                        可添加标签 
                        <span class="inline-block w-3 h-3 bg-gray-200 border border-gray-400 rounded-full mr-1 ml-4"></span>
                        已存在标签
                    </span>
                </div>
                <div class="flex flex-wrap gap-2">
            `;

            tags.forEach((tag, index) => {
                const tagClass = tag.isExisting ? 'existing' : 'new';
                const tagTitle = tag.isExisting ? 
                    `已存在于${getCategoryName(tag.category)}分类` : 
                    '点击添加为新标签';
                
                html += `
                    <span class="parsed-tag ${tagClass}" 
                          data-index="${index}"
                          title="${tagTitle}">
                        ${tag.text}
                    </span>
                `;
            });

            html += `
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <button id="selectAllParsedTags" class="btn btn-sm btn-primary">
                        <i class="fas fa-check"></i> 全选可添加标签
                    </button>
                    <button id="clearParsedTags" class="btn btn-sm btn-secondary">
                        <i class="fas fa-times"></i> 清空解析结果
                    </button>
                </div>
            `;

            parsedContainer.innerHTML = html;

            // 绑定解析标签的点击事件
            document.querySelectorAll('.parsed-tag').forEach((span, index) => {
                span.addEventListener('click', function() {
                    const tagIndex = parseInt(this.dataset.index);
                    const tag = tags[tagIndex];
                    
                    if (tag.isExisting && tag.existingTag && tag.category) {
                        // 添加已存在的标签
                        toggleTagSelection(tag.existingTag.id, tag.category);
                        this.style.opacity = '0.5';
                        this.style.pointerEvents = 'none';
                        showNotification(`已添加标签: ${tag.text}`, 'success');
                    } else {
                        // 打开新建标签模态框
                        openParseNewTagModal(tag.text);
                    }
                });
            });

            // 全选可添加标签
            const selectAllBtn = document.getElementById('selectAllParsedTags');
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', function() {
                    const newTags = tags.filter(tag => !tag.isExisting);
                    if (newTags.length === 0) {
                        showNotification('没有可添加的新标签', 'info');
                        return;
                    }
                    
                    // 这里保持原有的prompt方式，因为全选需要批量处理
                    const category = prompt('请选择分类:', 'custom');
                    if (!category) return;
                    
                    newTags.forEach(tag => {
                        const newTag = {
                            id: 'tag_' + Date.now() + Math.random().toString(36).substr(2, 9),
                            name: tag.text,
                            text: tag.text,
                            color: '#8B5CF6',
                            group: 'default',
                            pinned: false,
                            allowPin: true,
                            allowFavorite: true
                        };
                        
                        if (!settings.tags[category]) {
                            settings.tags[category] = [];
                        }
                        
                        settings.tags[category].push(newTag);
                        
                        // 添加到已选择标签
                        settings.selectedTags.push({
                            id: newTag.id,
                            name: newTag.name,
                            text: newTag.text,
                            weight: 1.0
                        });
                    });
                    
                    saveData();
                    renderTags();
                    updateSelectedTagsDisplay();
                    updatePrompt();
                    
                    showNotification(`已创建并添加 ${newTags.length} 个新标签`, 'success');
                    
                    // 隐藏解析结果
                    parsedContainer.style.display = 'none';
                });
            }

            // 清空解析结果
            const clearBtn = document.getElementById('clearParsedTags');
            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    parsedContainer.style.display = 'none';
                });
            }
            
            // 自动添加所有已存在的标签到已选择区域
            let existingTagsAdded = 0;
            tags.forEach((tag, index) => {
                if (tag.isExisting && tag.existingTag && tag.category) {
                    // 检查标签是否已经被选择
                    if (!isTagSelected(tag.existingTag.id)) {
                        // 添加已存在的标签
                        toggleTagSelection(tag.existingTag.id, tag.category);
                        existingTagsAdded++;
                    }
                    
                    // 更新UI状态
                    const tagElement = parsedContainer.querySelector(`.parsed-tag[data-index="${index}"]`);
                    if (tagElement) {
                        tagElement.style.opacity = '0.5';
                        tagElement.style.pointerEvents = 'none';
                    }
                }
            });
            
            // 如果有自动添加的标签，显示通知
            if (existingTagsAdded > 0) {
                showNotification(`已自动添加 ${existingTagsAdded} 个已存在标签`, 'success');
            }
        }

        // 打开解析新建标签模态框
        function openParseNewTagModal(tagText) {
            document.getElementById('parseTagText').value = tagText;
            document.getElementById('parseTagName').value = '';
            document.getElementById('parseTagColor').value = '#8B5CF6';
            
            // 加载分类选项
            const categorySelect = document.getElementById('parseTagCategory');
            categorySelect.innerHTML = '<option value="">请选择分类</option>';
            settings.mainCategories.forEach(category => {
                if (category.id !== 'favorites') { // 排除收藏分类
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                }
            });
            
            // 加载分组选项（默认分组）
            const groupSelect = document.getElementById('parseTagGroup');
            groupSelect.innerHTML = '<option value="default">默认分组</option>';
            
            document.getElementById('parseNewTagModal').classList.add('show');
        }

        // 确认解析新建标签
        function confirmParseTag() {
            const tagText = document.getElementById('parseTagText').value;
            const tagName = document.getElementById('parseTagName').value.trim();
            const category = document.getElementById('parseTagCategory').value;
            const group = document.getElementById('parseTagGroup').value;
            const color = document.getElementById('parseTagColor').value;
            
            if (!tagName) {
                showNotification('请输入标签的中文名称', 'error');
                return;
            }
            
            if (!category) {
                showNotification('请选择分类', 'error');
                return;
            }
            
            const newTag = {
                id: 'tag_' + Date.now(),
                name: tagName,
                text: tagText,
                color: color,
                group: group || 'default',
                pinned: false,
                allowPin: true,
                allowFavorite: true
            };
            
            if (!settings.tags[category]) {
                settings.tags[category] = [];
            }
            
            settings.tags[category].push(newTag);
            saveData();
            renderTags();
            
            // 添加到已选择标签
            settings.selectedTags.push({
                id: newTag.id,
                name: newTag.name,
                text: newTag.text,
                weight: 1.0
            });
            updateSelectedTagsDisplay();
            updatePrompt();
            
            document.getElementById('parseNewTagModal').classList.remove('show');
            showNotification(`已创建并添加标签: ${tagName}`, 'success');
            
            // 隐藏解析结果
            document.getElementById('parsedTagsContainer').style.display = 'none';
        }

        // 其他函数...
        function openEditTagModal(tagId, category) {
            const tag = findTagById(tagId, category);
            if (!tag) return;

            document.getElementById('editTagId').value = tagId;
            document.getElementById('editTagCategory').value = category;
            document.getElementById('editTagName').value = tag.name;
            document.getElementById('editTagText').value = tag.text;
            document.getElementById('editTagColor').value = tag.color;

            // 加载分组选项
            const groupSelect = document.getElementById('editTagGroup');
            groupSelect.innerHTML = '<option value="">请选择分组</option>';
            const groups = settings.groups[category] || [];
            groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name;
                option.selected = tag.group === group.id;
                groupSelect.appendChild(option);
            });

            document.getElementById('editTagAllowPin').checked = tag.allowPin !== false;
            document.getElementById('editTagAllowFavorite').checked = tag.allowFavorite !== false;

            document.getElementById('editTagModal').classList.add('show');
        }

        function confirmEditTag() {
            const tagId = document.getElementById('editTagId').value;
            const category = document.getElementById('editTagCategory').value;
            const name = document.getElementById('editTagName').value.trim();
            const text = document.getElementById('editTagText').value.trim();
            const color = document.getElementById('editTagColor').value;
            const group = document.getElementById('editTagGroup').value;
            const allowPin = document.getElementById('editTagAllowPin').checked;
            const allowFavorite = document.getElementById('editTagAllowFavorite').checked;

            if (!name || !text) {
                showNotification('标签名称和文本不能为空', 'error');
                return;
            }

            const tag = findTagById(tagId, category);
            if (tag) {
                tag.name = name;
                tag.text = text;
                tag.color = color;
                tag.group = group;
                tag.allowPin = allowPin;
                tag.allowFavorite = allowFavorite;

                saveData();
                renderTags();
                updateSelectedTagsDisplay();
                updatePrompt();

                document.getElementById('editTagModal').classList.remove('show');
                showNotification('标签已更新', 'success');
            }
        }

        function openNewTagModal(category, group) {
            document.getElementById('newTagCategory').value = category;
            document.getElementById('newTagGroup').value = group;
            document.getElementById('newTagName').value = '';
            document.getElementById('newTagText').value = '';
            document.getElementById('newTagColor').value = '#8B5CF6';

            // 加载分组选项
            const groupSelect = document.getElementById('newTagGroupSelect');
            groupSelect.innerHTML = '<option value="">请选择分组</option>';
            const groups = settings.groups[category] || [];
            groups.forEach(g => {
                const option = document.createElement('option');
                option.value = g.id;
                option.textContent = g.name;
                option.selected = g.id === group;
                groupSelect.appendChild(option);
            });

            document.getElementById('newTagAllowPin').checked = true;
            document.getElementById('newTagAllowFavorite').checked = true;

            document.getElementById('newTagModal').classList.add('show');
        }

        function confirmNewTag() {
            const category = document.getElementById('newTagCategory').value;
            const group = document.getElementById('newTagGroupSelect').value || document.getElementById('newTagGroup').value;
            const name = document.getElementById('newTagName').value.trim();
            const text = document.getElementById('newTagText').value.trim();
            const color = document.getElementById('newTagColor').value;
            const allowPin = document.getElementById('newTagAllowPin').checked;
            const allowFavorite = document.getElementById('newTagAllowFavorite').checked;

            if (!name || !text) {
                showNotification('标签名称和文本不能为空', 'error');
                return;
            }

            const newTag = {
                id: 'tag_' + Date.now(),
                name: name,
                text: text,
                color: color,
                group: group || 'default',
                pinned: false,
                allowPin: allowPin,
                allowFavorite: allowFavorite
            };

            if (!settings.tags[category]) {
                settings.tags[category] = [];
            }

            settings.tags[category].push(newTag);
            saveData();
            renderTags();

            document.getElementById('newTagModal').classList.remove('show');
            showNotification('标签创建成功', 'success');
        }

        function openAddGroupModal(category, parentGroup) {
            document.getElementById('newGroupCategory').value = category;
            document.getElementById('newGroupParent').value = parentGroup;
            document.getElementById('newGroupName').value = '';
            document.getElementById('newGroupDescription').value = '';

            document.getElementById('newGroupModal').classList.add('show');
        }

        function confirmNewGroup() {
            const category = document.getElementById('newGroupCategory').value;
            const parentGroup = document.getElementById('newGroupParent').value;
            const name = document.getElementById('newGroupName').value.trim();
            const description = document.getElementById('newGroupDescription').value.trim();

            if (!name) {
                showNotification('分组名称不能为空', 'error');
                return;
            }

            const newGroup = {
                id: 'group_' + Date.now(),
                name: name,
                description: description,
                parent: parentGroup
            };

            if (!settings.groups[category]) {
                settings.groups[category] = [];
            }

            settings.groups[category].push(newGroup);
            saveData();
            renderTags();

            document.getElementById('newGroupModal').classList.remove('show');
            showNotification('分组创建成功', 'success');
        }

        function openMainCategoryManagementModal() {
            renderMainCategoryList();
            document.getElementById('newMainCategoryName').value = '';
            document.getElementById('mainCategoryManagementModal').classList.add('show');
        }

        function renderMainCategoryList() {
            const container = document.getElementById('mainCategoryList');
            if (!container) return;

            container.innerHTML = '';

            settings.mainCategories.forEach((category, index) => {
                const item = document.createElement('div');
                item.className = 'category-item';
                item.innerHTML = `
                    <div class="category-name">
                        <div class="color-preview" style="background: ${category.color};"></div>
                        ${category.name}
                        ${category.isSystem ? '<span class="badge">系统</span>' : ''}
                    </div>
                    <div class="category-actions">
                        <button class="btn btn-sm btn-info edit-category-btn" 
                                data-index="${index}"
                                title="编辑">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${!category.isSystem ? `
                            <button class="btn btn-sm btn-danger delete-category-btn" 
                                    data-index="${index}"
                                    title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-secondary move-up-btn" 
                                data-index="${index}"
                                title="上移">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="btn btn-sm btn-secondary move-down-btn" 
                                data-index="${index}"
                                title="下移">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                    </div>
                `;

                container.appendChild(item);
            });

            // 绑定事件
            document.querySelectorAll('.edit-category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    editMainCategory(index);
                });
            });

            document.querySelectorAll('.delete-category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    deleteMainCategory(index);
                });
            });

            document.querySelectorAll('.move-up-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    moveMainCategory(index, -1);
                });
            });

            document.querySelectorAll('.move-down-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    moveMainCategory(index, 1);
                });
            });
        }

        function addMainCategory() {
            const name = document.getElementById('newMainCategoryName').value.trim();
            if (!name) {
                showNotification('分类名称不能为空', 'error');
                return;
            }

            const newCategory = {
                id: 'category_' + Date.now(),
                name: name,
                color: getRandomColor(),
                isSystem: false
            };

            settings.mainCategories.push(newCategory);
            
            // 初始化对应的标签和分组
            if (!settings.tags[newCategory.id]) {
                settings.tags[newCategory.id] = [];
            }

            if (!settings.groups[newCategory.id]) {
                settings.groups[newCategory.id] = [{ id: 'default', name: '默认分组', description: '默认分组' }];
            }

            saveData();
            renderMainCategoryList();
            renderTagTabButtons();
            document.getElementById('newMainCategoryName').value = '';

            showNotification(`已添加新分类: ${name}`, 'success');
        }

        function editMainCategory(index) {
            const category = settings.mainCategories[index];
            if (!category) return;

            const newName = prompt('请输入新的分类名称:', category.name);
            if (newName && newName.trim()) {
                category.name = newName.trim();
                saveData();
                renderMainCategoryList();
                renderTagTabButtons();
                showNotification('分类名称已更新', 'success');
            }
        }

        function deleteMainCategory(index) {
            const category = settings.mainCategories[index];
            if (!category) return;

            if (confirm(`确定要删除分类"${category.name}"吗？这将删除该分类下的所有标签和分组。`)) {
                const categoryId = category.id;

                // 删除分类
                settings.mainCategories.splice(index, 1);

                // 删除对应的标签和分组
                if (settings.tags[categoryId]) {
                    delete settings.tags[categoryId];
                }

                if (settings.groups[categoryId]) {
                    delete settings.groups[categoryId];
                }

                // 如果当前选中的是被删除的分类，切换到第一个分类
                if (settings.currentTab === categoryId) {
                    settings.currentTab = settings.mainCategories.length > 0 ? settings.mainCategories[0].id : 'favorites';
                }

                saveData();
                renderMainCategoryList();
                renderTagTabButtons();
                renderTags();

                showNotification(`已删除分类: ${category.name}`, 'success');
            }
        }

        function moveMainCategory(index, direction) {
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < settings.mainCategories.length) {
                [settings.mainCategories[index], settings.mainCategories[newIndex]] =
                    [settings.mainCategories[newIndex], settings.mainCategories[index]];

                saveData();
                renderMainCategoryList();
                renderTagTabButtons();
                showNotification('分类顺序已调整', 'success');
            }
        }

        function openPresetCategoryManagementModal() {
            renderPresetCategoryList();
            document.getElementById('newPresetCategoryName').value = '';
            document.getElementById('presetCategoryManagementModal').classList.add('show');
        }

        function renderPresetCategoryList() {
            const container = document.getElementById('presetCategoryList');
            if (!container) return;

            container.innerHTML = '';

            settings.presetCategories.forEach((category, index) => {
                const item = document.createElement('div');
                item.className = 'category-item';
                item.innerHTML = `
                    <div class="category-name">
                        ${category.name}
                        ${category.isSystem ? '<span class="badge">系统</span>' : ''}
                    </div>
                    <div class="category-actions">
                        <button class="btn btn-sm btn-info edit-preset-category-btn" 
                                data-index="${index}"
                                title="编辑">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${!category.isSystem ? `
                            <button class="btn btn-sm btn-danger delete-preset-category-btn" 
                                    data-index="${index}"
                                    title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-secondary move-up-btn" 
                                data-index="${index}"
                                title="上移">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="btn btn-sm btn-secondary move-down-btn" 
                                data-index="${index}"
                                title="下移">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                    </div>
                `;

                container.appendChild(item);
            });

            // 绑定事件
            document.querySelectorAll('.edit-preset-category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    editPresetCategory(index);
                });
            });

            document.querySelectorAll('.delete-preset-category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    deletePresetCategory(index);
                });
            });

            document.querySelectorAll('.move-up-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    movePresetCategory(index, -1);
                });
            });

            document.querySelectorAll('.move-down-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    movePresetCategory(index, 1);
                });
            });
        }

        function addPresetCategory() {
            const name = document.getElementById('newPresetCategoryName').value.trim();
            if (!name) {
                showNotification('分类名称不能为空', 'error');
                return;
            }

            const newCategory = {
                id: 'preset_category_' + Date.now(),
                name: name,
                isSystem: false
            };

            settings.presetCategories.push(newCategory);
            
            // 初始化对应的Preset
            if (!settings.presets[newCategory.id]) {
                settings.presets[newCategory.id] = [];
            }

            saveData();
            renderPresetCategoryList();
            renderPresetTabButtons();
            document.getElementById('newPresetCategoryName').value = '';

            showNotification(`已添加新分类: ${name}`, 'success');
        }

        function editPresetCategory(index) {
            const category = settings.presetCategories[index];
            if (!category) return;

            const newName = prompt('请输入新的分类名称:', category.name);
            if (newName && newName.trim()) {
                category.name = newName.trim();
                saveData();
                renderPresetCategoryList();
                renderPresetTabButtons();
                showNotification('分类名称已更新', 'success');
            }
        }

        function deletePresetCategory(index) {
            const category = settings.presetCategories[index];
            if (!category) return;

            if (confirm(`确定要删除分类"${category.name}"吗？这将删除该分类下的所有Preset。`)) {
                const categoryId = category.id;

                // 删除分类
                settings.presetCategories.splice(index, 1);

                // 删除对应的Preset
                if (settings.presets[categoryId]) {
                    delete settings.presets[categoryId];
                }

                // 如果当前选中的是被删除的分类，切换到第一个分类
                if (settings.currentPresetTab === categoryId) {
                    settings.currentPresetTab = settings.presetCategories.length > 0 ? settings.presetCategories[0].id : 'anime';
                }

                saveData();
                renderPresetCategoryList();
                renderPresetTabButtons();
                renderPresets();

                showNotification(`已删除分类: ${category.name}`, 'success');
            }
        }

        function movePresetCategory(index, direction) {
            const newIndex = index + direction;
            if (newIndex >= 0 && newIndex < settings.presetCategories.length) {
                [settings.presetCategories[index], settings.presetCategories[newIndex]] =
                    [settings.presetCategories[newIndex], settings.presetCategories[index]];

                saveData();
                renderPresetCategoryList();
                renderPresetTabButtons();
                showNotification('分类顺序已调整', 'success');
            }
        }

        function openNewPresetModal() {
            // 加载分类选项
            const categorySelect = document.getElementById('newPresetCategory');
            categorySelect.innerHTML = '<option value="">请选择分类</option>';
            settings.presetCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });

            document.getElementById('newPresetName').value = '';
            document.getElementById('newPresetDescription').value = '';
            document.getElementById('newPresetPrompt').value = '';
            document.getElementById('newPresetRating').value = '5';
            updateRatingStars('newPresetRatingStars', 5);

            document.getElementById('newPresetModal').classList.add('show');
        }

        function confirmNewPreset() {
            const name = document.getElementById('newPresetName').value.trim();
            const description = document.getElementById('newPresetDescription').value.trim();
            const category = document.getElementById('newPresetCategory').value;
            const prompt = document.getElementById('newPresetPrompt').value.trim();
            const rating = parseInt(document.getElementById('newPresetRating').value);
            const imageData = document.getElementById('newPresetImageData').value;

            if (!name || !category || !prompt) {
                showNotification('名称、分类和Prompt内容不能为空', 'error');
                return;
            }

            const newPreset = {
                id: 'preset_' + Date.now(),
                name: name,
                description: description,
                prompt: prompt,
                category: category,
                rating: rating,
                favorite: false,
                image: imageData || null
            };

            if (!settings.presets[category]) {
                settings.presets[category] = [];
            }

            settings.presets[category].push(newPreset);
            saveData();
            renderPresets();

            document.getElementById('newPresetModal').classList.remove('show');
            showNotification('Prompt创建成功', 'success');
            
            // 重置表单
            document.getElementById('newPresetName').value = '';
            document.getElementById('newPresetDescription').value = '';
            document.getElementById('newPresetPrompt').value = '';
            document.getElementById('newPresetRating').value = '5';
            document.getElementById('newPresetImageData').value = '';
            updateRatingStars('newPresetRatingStars', 5);
            resetImagePreview('newPresetImagePreview');
        }

        function openEditPresetModal(presetId, category) {
            const preset = settings.presets[category].find(p => p.id === presetId);
            if (!preset) return;

            document.getElementById('editPresetId').value = presetId;
            document.getElementById('editPresetCategory').value = category;
            document.getElementById('editPresetName').value = preset.name;
            document.getElementById('editPresetDescription').value = preset.description;
            document.getElementById('editPresetPrompt').value = preset.prompt;
            document.getElementById('editPresetRating').value = preset.rating;
            updateRatingStars('editPresetRatingStars', preset.rating);
            
            // 加载图片数据
            document.getElementById('editPresetImageData').value = preset.image || '';
            const imagePreview = document.getElementById('editPresetImagePreview');
            if (preset.image) {
                imagePreview.innerHTML = `<img src="${preset.image}" alt="Preview">`;
            } else {
                resetImagePreview('editPresetImagePreview');
            }

            // 加载分类选项
            const categorySelect = document.getElementById('editPresetCategorySelect');
            categorySelect.innerHTML = '<option value="">请选择分类</option>';
            settings.presetCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                option.selected = cat.id === preset.category;
                categorySelect.appendChild(option);
            });

            document.getElementById('editPresetModal').classList.add('show');
        }

        function confirmEditPreset() {
            const presetId = document.getElementById('editPresetId').value;
            const oldCategory = document.getElementById('editPresetCategory').value;
            const name = document.getElementById('editPresetName').value.trim();
            const description = document.getElementById('editPresetDescription').value.trim();
            const newCategory = document.getElementById('editPresetCategorySelect').value;
            const prompt = document.getElementById('editPresetPrompt').value.trim();
            const rating = parseInt(document.getElementById('editPresetRating').value);
            const imageData = document.getElementById('editPresetImageData').value;

            if (!name || !newCategory || !prompt) {
                showNotification('名称、分类和Prompt内容不能为空', 'error');
                return;
            }

            const preset = settings.presets[oldCategory].find(p => p.id === presetId);
            if (preset) {
                // 如果分类改变，需要移动Preset
                if (oldCategory !== newCategory) {
                    // 从旧分类中删除
                    const index = settings.presets[oldCategory].findIndex(p => p.id === presetId);
                    if (index > -1) {
                        settings.presets[oldCategory].splice(index, 1);
                    }

                    // 添加到新分类
                    if (!settings.presets[newCategory]) {
                        settings.presets[newCategory] = [];
                    }
                    settings.presets[newCategory].push(preset);
                }

                // 更新Preset信息
                preset.name = name;
                preset.description = description;
                preset.prompt = prompt;
                preset.category = newCategory;
                preset.rating = rating;
                preset.image = imageData || null;

                saveData();
                renderPresets();

                document.getElementById('editPresetModal').classList.remove('show');
                showNotification('Prompt已更新', 'success');
            }
        }

        function applyPreset(presetId, category) {
            const preset = settings.presets[category].find(p => p.id === presetId);
            if (!preset) return;

            document.getElementById('positivePrompt').value = preset.prompt;
            showNotification('Prompt已应用', 'success');
        }

        function deletePreset(presetId, category) {
            if (confirm('确定要删除这个Prompt吗？')) {
                const index = settings.presets[category].findIndex(p => p.id === presetId);
                if (index > -1) {
                    settings.presets[category].splice(index, 1);
                    saveData();
                    renderPresets();
                    showNotification('Prompt已删除', 'success');
                }
            }
        }

        function togglePresetFavorite(presetId, category) {
            const preset = settings.presets[category].find(p => p.id === presetId);
            if (preset) {
                preset.favorite = !preset.favorite;
                saveData();
                renderPresets();
                showNotification(preset.favorite ? 'Prompt已收藏' : 'Prompt已取消收藏', 'success');
            }
        }

        function openDataManagementModal() {
            document.getElementById('dataManagementModal').classList.add('show');
        }

        function exportAllData() {
            const exportData = {
                mainCategories: settings.mainCategories,
                tags: settings.tags,
                groups: settings.groups,
                presetCategories: settings.presetCategories,
                presets: settings.presets,
                settings: {
                    showPlusMinus: settings.showPlusMinus,
                    weightSymbol: settings.weightSymbol,
                    showDelete: settings.showDelete,
                    showR18Groups: settings.showR18Groups,
                    showNegative: settings.showNegative,
                    favorites: settings.favorites
                },
                version: '3.4.9',
                作者: 'Mayi',
                Github: 'https://clay2001.github.io/Prompt-UI/',
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `comfyui_prompt_generator_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('数据导出成功', 'success');
        }

        function showImportOptions() {
            document.getElementById('importOptions').classList.add('show');
        }

        function hideImportOptions() {
            document.getElementById('importOptions').classList.remove('show');
            document.getElementById('importFile').value = '';
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // 验证数据格式
                    if (!importedData.mainCategories || !importedData.tags || !importedData.groups || !importedData.presetCategories || !importedData.presets) {
                        throw new Error('数据格式不正确');
                    }

                    // 确认导入
                    if (confirm('确定要导入数据吗？这将覆盖现有数据。')) {
                        // 导入数据
                        settings.mainCategories = importedData.mainCategories;
                        settings.tags = importedData.tags;
                        settings.groups = importedData.groups;
                        settings.presetCategories = importedData.presetCategories;
                        settings.presets = importedData.presets;

                        // 导入设置
                        if (importedData.settings) {
                            settings.showPlusMinus = importedData.settings.showPlusMinus !== undefined ? importedData.settings.showPlusMinus : true;
                            settings.weightSymbol = importedData.settings.weightSymbol || '()';
                            settings.showDelete = importedData.settings.showDelete !== undefined ? importedData.settings.showDelete : true;
                            settings.showR18Groups = importedData.settings.showR18Groups !== undefined ? importedData.settings.showR18Groups : false;
                            settings.showNegative = importedData.settings.showNegative !== undefined ? importedData.settings.showNegative : false;
                            settings.favorites = importedData.settings.favorites || [];
                        }

                        // 强制将所有分类的isSystem设置为false
                        settings.mainCategories.forEach(category => {
                            category.isSystem = false;
                        });

                        settings.presetCategories.forEach(category => {
                            category.isSystem = false;
                        });

                        // 为旧数据添加评分和收藏字段
                        Object.keys(settings.presets).forEach(category => {
                            settings.presets[category].forEach(preset => {
                                if (preset.rating === undefined) preset.rating = 5;
                                if (preset.favorite === undefined) preset.favorite = false;
                            });
                        });

                        saveData();
                        renderTagTabButtons();
                        renderPresetTabButtons();
                        renderTags();
                        renderPresets();
                        updateSelectedTagsDisplay();
                        updatePrompt();

                        showNotification('数据导入成功！页面已更新', 'success');
                    }
                } catch (error) {
                    console.error('导入数据失败:', error);
                    showNotification('导入失败：文件格式错误或内容损坏', 'danger');
                }

                hideImportOptions();
            };

            reader.readAsText(file);
        }

        function resetAllData() {
            if (confirm('确定要重置所有数据吗？这将清除所有自定义数据并恢复到初始状态。')) {
                try {
                    // 清除localStorage
                    localStorage.removeItem('comfyui_v3_16_1015_main_categories');
                    localStorage.removeItem('comfyui_v3_16_1015_tags');
                    localStorage.removeItem('comfyui_v3_16_1015_groups');
                    localStorage.removeItem('comfyui_v3_16_1015_preset_categories');
                    localStorage.removeItem('comfyui_v3_16_1015_presets');
                    localStorage.removeItem('comfyui_v3_16_1015_settings');

                    // 重新加载默认数据
                    settings.mainCategories = JSON.parse(JSON.stringify(defaultMainCategories));
                    settings.tags = JSON.parse(JSON.stringify(defaultTags));
                    settings.groups = JSON.parse(JSON.stringify(defaultGroups));
                    settings.presetCategories = JSON.parse(JSON.stringify(defaultPresetCategories));
                    settings.presets = JSON.parse(JSON.stringify(defaultPresets));
                    settings.showPlusMinus = true;
                    settings.weightSymbol = '()';
                    settings.showDelete = true;
                    settings.showR18Groups = false;
                    settings.showNegative = false;
                    settings.currentTab = 'favorites';
                    settings.currentPresetTab = 'anime';
                    settings.selectedTags = [];
                    settings.favorites = [];

                    saveData();
                    renderTagTabButtons();
                    renderPresetTabButtons();
                    renderTags();
                    renderPresets();
                    updateSelectedTagsDisplay();
                    updatePrompt();

                    showNotification('已重置所有数据到初始状态', 'success');
                } catch (error) {
                    console.error('重置数据失败:', error);
                    showNotification('数据重置失败，请重试', 'danger');
                }
            }
        }

        function showLocalStorageInfo() {
            try {
                const info = [];
                const keys = [
                    'comfyui_v3_16_1015_main_categories',
                    'comfyui_v3_16_1015_tags',
                    'comfyui_v3_16_1015_groups',
                    'comfyui_v3_16_1015_preset_categories',
                    'comfyui_v3_16_1015_presets',
                    'comfyui_v3_16_1015_settings'
                ];

                let totalSize = 0;
                keys.forEach(key => {
                    const value = localStorage.getItem(key);
                    const size = value ? value.length : 0;
                    totalSize += size;
                    info.push({
                        key: key,
                        size: formatBytes(size),
                        exists: !!value
                    });
                });

                const container = document.getElementById('storageInfoContent');
                container.innerHTML = `
                    <div class="space-y-4">
                        <div class="text-center">
                            <h4 class="font-semibold mb-2">本地存储使用情况</h4>
                            <p class="text-lg font-bold text-primary">总计: ${formatBytes(totalSize)}</p>
                            <small class="text-gray-600">约${Math.round(totalSize / 1024)} KB</small>
                        </div>
                        <div class="space-y-2">
                            ${info.map(item => `
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <span class="text-sm">${item.key.replace('comfyui_v3_16_1015_', '')}</span>
                                    <span class="text-sm font-semibold ${item.exists ? 'text-green-600' : 'text-gray-400'}">
                                        ${item.exists ? item.size : '不存在'}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-4 p-3 bg-blue-50 rounded border border-blue-200">
                            <h5 class="font-semibold text-blue-800 mb-2">数据统计</h5>
                            <div class="text-sm space-y-1">
                                <div class="flex justify-between">
                                    <span>主分类数量:</span>
                                    <span class="font-semibold">${settings.mainCategories.length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>标签总数:</span>
                                    <span class="font-semibold">${Object.values(settings.tags).reduce((sum, tags) => sum + tags.length, 0)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>分组总数:</span>
                                    <span class="font-semibold">${Object.values(settings.groups).reduce((sum, groups) => sum + groups.length, 0)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Prompt分类数量:</span>
                                    <span class="font-semibold">${settings.presetCategories.length}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Prompt总数:</span>
                                    <span class="font-semibold">${Object.values(settings.presets).reduce((sum, presets) => sum + presets.length, 0)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>收藏标签数量:</span>
                                    <span class="font-semibold">${settings.favorites.length}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('localStorageInfoModal').classList.add('show');
            } catch (error) {
                console.error('获取存储信息失败:', error);
                showNotification('获取存储信息失败', 'error');
            }
        }

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';

            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];

            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function getRandomColor() {
            const colors = [
                '#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e',
                '#10b981', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1',
                '#8b5cf6', '#a855f7', '#d946ef', '#ec4899', '#f43f5e'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        

    </script>
    <footer class="w-full mt-6 text-center text-xs text-slate-600 py-4 border-t border-slate-200 bg-white/60">
        <div class="flex flex-wrap justify-center items-center gap-2">
            <span>© 2025 Mayi Prompt UI</span>
            <span class="mx-2">•</span>
            <span>版本 3.4.9</span>
            <span class="mx-2">•</span>
            <a href="https://github.com/clay2001/Prompt-UI" target="_blank" rel="noopener" class="text-primary hover:underline">GitHub</a>
        </div>
    </footer>
</body>
</html>